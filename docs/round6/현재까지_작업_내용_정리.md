# Round 6 PG ì—°ë™ - í˜„ì¬ê¹Œì§€ ì‘ì—… ë‚´ìš© ì •ë¦¬

## ğŸ“… ì‘ì—… ì¼ì
2025ë…„ (í˜„ì¬ ì§„í–‰ ì¤‘)

## ğŸ¯ ì‘ì—… ëª©í‘œ
- PG Simulatorì™€ì˜ ì—°ë™ êµ¬í˜„
- Resilience4jë¥¼ í™œìš©í•œ ì¥ì•  ëŒ€ì‘ íŒ¨í„´ ì ìš©
- ë¹„ë™ê¸° ê²°ì œ ì½œë°± ì²˜ë¦¬ ë° ì¬ê³  ì°¨ê° ë¡œì§ êµ¬í˜„

---

## âœ… ì™„ë£Œëœ ì‘ì—… ëª©ë¡

### 1. ì˜ì¡´ì„± ì¶”ê°€ ë° ì„¤ì •
#### ğŸ“ `apps/commerce-api/build.gradle.kts`
```kotlin
// OpenFeign
implementation("org.springframework.cloud:spring-cloud-starter-openfeign:4.1.0")

// Resilience4j
implementation("io.github.resilience4j:resilience4j-spring-boot3:2.2.0")
implementation("org.springframework.boot:spring-boot-starter-aop")
```

**ì™„ë£Œ ë‚´ìš©:**
- âœ… OpenFeign ì˜ì¡´ì„± ì¶”ê°€ (ì„ ì–¸ì  HTTP í´ë¼ì´ì–¸íŠ¸)
- âœ… Resilience4j ì˜ì¡´ì„± ì¶”ê°€ (CircuitBreaker, TimeLimiter)
- âœ… Spring AOP ì˜ì¡´ì„± ì¶”ê°€ (Resilience4j ì–´ë…¸í…Œì´ì…˜ ì‚¬ìš©)

---

### 2. Payment ë„ë©”ì¸ êµ¬í˜„

#### ğŸ“ `Payment.kt` - ì—”í‹°í‹°
**ìœ„ì¹˜:** `apps/commerce-api/src/main/kotlin/com/loopers/domain/payment/Payment.kt`

**ì£¼ìš” íŠ¹ì§•:**
- âœ… `@Table(name = "commerce_payments")` - pg-simulatorì™€ í…Œì´ë¸”ëª… ì¶©ëŒ ë°©ì§€
- âœ… ì£¼ìš” í•„ë“œ:
  - `orderId: Long` - ì£¼ë¬¸ ID
  - `amount: Money` - ê²°ì œ ê¸ˆì•¡
  - `paymentMethod: PaymentMethod` - ê²°ì œ ìˆ˜ë‹¨ (POINT, CARD)
  - `status: PaymentStatus` - ê²°ì œ ìƒíƒœ (PENDING, SUCCESS, FAILED)
  - `transactionKey: String?` - PG ê±°ë˜ ë²ˆí˜¸
  - `cardType: String?` - ì¹´ë“œ íƒ€ì…
  - `cardNo: String?` - ì¹´ë“œ ë²ˆí˜¸
  - `failureReason: String?` - ì‹¤íŒ¨ ì‚¬ìœ 

**ìƒíƒœ ì „ì´ ë©”ì„œë“œ:**
- âœ… `markAsSuccess()` - PENDING â†’ SUCCESS
- âœ… `markAsFailed(reason: String)` - PENDING â†’ FAILED

**íŒ©í† ë¦¬ ë©”ì„œë“œ:**
- âœ… `createCardPayment()` - ì¹´ë“œ ê²°ì œ ìƒì„±
- âœ… `createFailedPayment()` - ì‹¤íŒ¨í•œ ê²°ì œ ìƒì„±

#### ğŸ“ `PaymentStatus.kt` - Enum
```kotlin
enum class PaymentStatus(val description: String) {
    PENDING("ê²°ì œ ëŒ€ê¸°"),
    SUCCESS("ê²°ì œ ì„±ê³µ"),
    FAILED("ê²°ì œ ì‹¤íŒ¨"),
    TIMEOUT("ê²°ì œ íƒ€ì„ì•„ì›ƒ"),
    CANCELLED("ê²°ì œ ì·¨ì†Œ")
}
```

#### ğŸ“ `PaymentMethod.kt` - Enum
```kotlin
enum class PaymentMethod(val description: String) {
    POINT("í¬ì¸íŠ¸ ê²°ì œ"),
    CARD("ì¹´ë“œ ê²°ì œ")
}
```

#### ğŸ“ `PaymentRepository.kt` - ì¸í„°í˜ì´ìŠ¤
```kotlin
interface PaymentRepository {
    fun save(payment: Payment): Payment
    fun findByTransactionKey(transactionKey: String): Payment?
    fun findByOrderId(orderId: Long): List<Payment>
}
```

#### ğŸ“ `PaymentJpaRepository.kt` + `PaymentRepositoryImpl.kt`
- âœ… Spring Data JPA ë¦¬í¬ì§€í† ë¦¬ êµ¬í˜„
- âœ… ì¸í”„ë¼ ë ˆì´ì–´ì—ì„œ ë„ë©”ì¸ ë ˆì´ì–´ êµ¬í˜„

---

### 3. PG Client êµ¬í˜„ (FeignClient)

#### ğŸ“ `PgSimulatorClient.kt`
**ìœ„ì¹˜:** `apps/commerce-api/src/main/kotlin/com/loopers/infrastructure/pg/PgSimulatorClient.kt`

```kotlin
@FeignClient(
    name = "pg-simulator",
    url = "\${pg.base-url}",
    configuration = [PgClientConfig::class]
)
interface PgSimulatorClient {
    @PostMapping("/api/v1/payments")
    fun requestPayment(
        @RequestHeader("X-USER-ID") userId: String,
        @RequestBody request: PgDto.PaymentRequest
    ): PgDto.PaymentResponse

    @GetMapping("/api/v1/payments/{transactionKey}")
    fun getPaymentStatus(
        @RequestHeader("X-USER-ID") userId: String,
        @PathVariable transactionKey: String
    ): PgDto.PaymentStatusResponse

    @GetMapping("/api/v1/payments")
    fun getPaymentsByOrderId(
        @RequestHeader("X-USER-ID") userId: String,
        @RequestParam orderId: String
    ): PgDto.OrderPaymentsResponse
}
```

**ì™„ë£Œ ë‚´ìš©:**
- âœ… FeignClient ì¸í„°í˜ì´ìŠ¤ ì •ì˜
- âœ… PG Simulator API 3ê°œ ì—”ë“œí¬ì¸íŠ¸ ì—°ë™
  - ê²°ì œ ìš”ì²­ (POST)
  - ê²°ì œ ìƒíƒœ ì¡°íšŒ (GET by transactionKey)
  - ì£¼ë¬¸ë³„ ê²°ì œ ëª©ë¡ ì¡°íšŒ (GET by orderId)
- âœ… X-USER-ID í—¤ë” ì „ì†¡

#### ğŸ“ `PgClientConfig.kt`
```kotlin
@Configuration
class PgClientConfig {
    @Bean
    fun feignRequestOptions(): Request.Options {
        return Request.Options(
            1000,  // connectTimeout (ms)
            3000   // readTimeout (ms)
        )
    }
}
```

**íƒ€ì„ì•„ì›ƒ ì„¤ì • ê·¼ê±°:**
- connectTimeout: 1ì´ˆ (ì—°ê²°ë§Œ ë¹ ë¥´ê²Œ)
- readTimeout: 3ì´ˆ (ë¹„ë™ê¸° ì½œë°± ë°©ì‹ì´ë¯€ë¡œ ìš”ì²­ ì ‘ìˆ˜ë§Œ í™•ì¸)

#### ğŸ“ `FeignConfig.kt`
```kotlin
@Configuration
@EnableFeignClients(basePackages = ["com.loopers"])
class FeignConfig
```

#### ğŸ“ `PgDto.kt`
- âœ… PG API ìš”ì²­/ì‘ë‹µ DTO ì •ì˜
- âœ… `PaymentRequest`, `PaymentResponse`, `PaymentStatusResponse`, `OrderPaymentsResponse`

---

### 4. ì „ëµ íŒ¨í„´ ì ìš© (PG Strategy)

#### ğŸ“ `PgStrategy.kt` - ì¸í„°í˜ì´ìŠ¤
**ìœ„ì¹˜:** `apps/commerce-api/src/main/kotlin/com/loopers/domain/payment/strategy/PgStrategy.kt`

```kotlin
interface PgStrategy {
    fun supports(paymentMethod: PaymentMethod): Boolean
    fun requestPayment(userId: String, request: PgDto.PaymentRequest): PgDto.PaymentResponse
    fun getPaymentStatus(userId: String, transactionKey: String): PgDto.PaymentStatusResponse
}
```

**ì„¤ê³„ ì˜ë„:**
- ì—¬ëŸ¬ PGì‚¬ ì¶”ê°€ ì‹œ í™•ì¥ ìš©ì´ (OCP ì›ì¹™)
- ì „ëµ ì„ íƒ ë¡œì§ ë¶„ë¦¬

#### ğŸ“ `SimulatorPgStrategy.kt` - êµ¬í˜„ì²´
```kotlin
@Component
class SimulatorPgStrategy(
    private val pgSimulatorClient: PgSimulatorClient
) : PgStrategy {
    override fun supports(paymentMethod: PaymentMethod): Boolean {
        return paymentMethod == PaymentMethod.CARD
    }

    override fun requestPayment(userId: String, request: PgDto.PaymentRequest): PgDto.PaymentResponse {
        return pgSimulatorClient.requestPayment(userId, request)
    }

    override fun getPaymentStatus(userId: String, transactionKey: String): PgDto.PaymentStatusResponse {
        return pgSimulatorClient.getPaymentStatus(userId, transactionKey)
    }
}
```

**í™•ì¥ ê°€ëŠ¥ì„±:**
- í–¥í›„ `TossPgStrategy`, `NicePayPgStrategy` ë“± ì¶”ê°€ ê°€ëŠ¥

---

### 5. PaymentService êµ¬í˜„ (í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§)

#### ğŸ“ `PaymentService.kt`
**ìœ„ì¹˜:** `apps/commerce-api/src/main/kotlin/com/loopers/domain/payment/PaymentService.kt`

**ì£¼ìš” ë©”ì„œë“œ:**

##### `requestCardPayment()` - ê²°ì œ ìš”ì²­
```kotlin
@CircuitBreaker(name = "pgCircuit", fallbackMethod = "paymentFallback")
@TimeLimiter(name = "pgTimeLimiter")
@Transactional
fun requestCardPayment(
    order: Order,
    userId: String,
    cardType: String,
    cardNo: String
): Payment
```

**êµ¬í˜„ ë‚´ìš©:**
- âœ… ì „ëµ íŒ¨í„´ìœ¼ë¡œ PG ì„ íƒ (`pgStrategies.firstOrNull { it.supports(PaymentMethod.CARD) }`)
- âœ… PG ê²°ì œ ìš”ì²­ API í˜¸ì¶œ
- âœ… Payment ì—”í‹°í‹° ìƒì„± (PENDING ìƒíƒœ)
- âœ… CircuitBreaker ì ìš©
- âœ… TimeLimiter ì ìš© (3ì´ˆ)

##### `paymentFallback()` - Fallback ë©”ì„œë“œ
```kotlin
private fun paymentFallback(
    order: Order,
    userId: String,
    cardType: String,
    cardNo: String,
    ex: Exception
): Payment
```

**Fallback ì „ëµ:**
- âœ… ì‹¤íŒ¨í•œ Payment ê¸°ë¡ ìƒì„± (status: FAILED)
- âœ… ì¬ê³  ì°¨ê°í•˜ì§€ ì•ŠìŒ (GMV ë³´í˜¸)
- âœ… ì‚¬ìš©ìì—ê²Œ ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€ ë°˜í™˜
- âœ… `PAYMENT_UNAVAILABLE` ì˜ˆì™¸ ë°œìƒ

---

### 6. ì½œë°± ì²˜ë¦¬ êµ¬í˜„

#### ğŸ“ `PaymentCallbackController.kt`
**ìœ„ì¹˜:** `apps/commerce-api/src/main/kotlin/com/loopers/interfaces/api/payment/PaymentCallbackController.kt`

```kotlin
@RestController
@RequestMapping("/api/v1/payments")
class PaymentCallbackController(
    private val paymentCallbackService: PaymentCallbackService
) {
    @PostMapping("/callback")
    fun handleCallback(@RequestBody callback: PaymentCallbackDto): ApiResponse<Unit> {
        paymentCallbackService.handlePaymentCallback(callback)
        return ApiResponse.success()
    }
}
```

#### ğŸ“ `PaymentCallbackDto.kt`
```kotlin
data class PaymentCallbackDto(
    val transactionKey: String,
    val status: String,
    val reason: String?
) {
    fun isSuccess(): Boolean = status == "SUCCESS"
}
```

#### ğŸ“ `PaymentCallbackService.kt`
**ìœ„ì¹˜:** `apps/commerce-api/src/main/kotlin/com/loopers/domain/payment/PaymentCallbackService.kt`

**í•µì‹¬ ë¡œì§:**

```kotlin
@Transactional
fun handlePaymentCallback(callback: PaymentCallbackDto) {
    // 1. Payment ì¡°íšŒ
    val payment = paymentRepository.findByTransactionKey(callback.transactionKey)
        ?: throw CoreException(ErrorType.PAYMENT_NOT_FOUND)

    // 2. ë©±ë“±ì„± ì²´í¬ (ì´ë¯¸ ì²˜ë¦¬ëœ ì½œë°± ë¬´ì‹œ)
    if (payment.status != PaymentStatus.PENDING) {
        logger.warn("Already processed payment: paymentId=${payment.id}")
        return
    }

    // 3. Order ì¡°íšŒ
    val order = orderRepository.findByIdOrThrow(payment.orderId)

    if (callback.isSuccess()) {
        // 4-1. ê²°ì œ ì„±ê³µ â†’ ì¬ê³  ì°¨ê°
        try {
            productService.decreaseStockByOrder(order)
            payment.markAsSuccess()
            order.complete()
        } catch (e: Exception) {
            // ì¬ê³  ë¶€ì¡± ì‹œ ì‹¤íŒ¨ ì²˜ë¦¬ (TODO: PG ì·¨ì†Œ ìš”ì²­ í•„ìš”)
            payment.markAsFailed("ì¬ê³  ì°¨ê° ì‹¤íŒ¨: ${e.message}")
            order.fail()
        }
    } else {
        // 4-2. ê²°ì œ ì‹¤íŒ¨
        payment.markAsFailed(callback.reason ?: "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜")
        order.fail()
    }
}
```

**ì™„ë£Œëœ ì£¼ìš” ê¸°ëŠ¥:**
- âœ… ë©±ë“±ì„± ë³´ì¥ (ì¤‘ë³µ ì½œë°± ë¬´ì‹œ)
- âœ… ê²°ì œ ì„±ê³µ ì‹œ ì¬ê³  ì°¨ê°
- âœ… ê²°ì œ ì‹¤íŒ¨ ì‹œ Order ì‹¤íŒ¨ ì²˜ë¦¬
- âœ… ì¬ê³  ë¶€ì¡± ì˜ˆì™¸ ì²˜ë¦¬

**TODO (ë¯¸ì™„ë£Œ):**
- â³ ì¬ê³  ë¶€ì¡± ì‹œ PG ì·¨ì†Œ API í˜¸ì¶œ
- â³ CS íŒ€ ì•Œë¦¼ ë¡œì§

---

### 7. OrderServiceì— ì¹´ë“œ ê²°ì œ í†µí•©

#### ğŸ“ `OrderService.kt` - `createOrderWithCardPayment()` ë©”ì„œë“œ ì¶”ê°€
**ìœ„ì¹˜:** `apps/commerce-api/src/main/kotlin/com/loopers/domain/order/OrderService.kt`

```kotlin
@Transactional
fun createOrderWithCardPayment(
    memberId: String,
    orderItems: List<OrderItemCommand>,
    cardType: String,
    cardNo: String,
    couponId: Long? = null
): Order {
    // 1. ìƒí’ˆ ì¡°íšŒ (ë½ ì—†ì´ - ì¬ê³  ì°¨ê° ì•ˆ í•˜ë¯€ë¡œ)
    val productMap = productRepository.findAllByIdIn(
        orderItems.map { it.productId }
    ).associateBy { it.id }

    // 2. ì¬ê³  ê²€ì¦ë§Œ ìˆ˜í–‰ (ì°¨ê°í•˜ì§€ ì•ŠìŒ!)
    orderItems.forEach { item ->
        val product = productMap[item.productId] ?: throw CoreException(...)
        product.validateStock(item.quantity)  // ê²€ì¦ë§Œ!
    }

    // 3. ì¿ í° í• ì¸ ê³„ì‚°
    val discountAmount = couponService.calculateDiscount(...)

    // 4. Order ìƒì„± (PENDING ìƒíƒœ)
    val order = Order.create(memberId, orderItems, productMap, discountAmount)
    orderRepository.save(order)

    // 5. PG ê²°ì œ ìš”ì²­
    try {
        paymentService.requestCardPayment(order, memberId, cardType, cardNo)
        // "ê²°ì œ ì§„í–‰ ì¤‘" ìƒíƒœ ë°˜í™˜
        return order
    } catch (e: CoreException) {
        // PG ìš”ì²­ ì‹¤íŒ¨ ì‹œ Order ì‹¤íŒ¨ ì²˜ë¦¬
        order.fail()
        orderRepository.save(order)
        throw e
    }
}
```

**í•µì‹¬ ì„¤ê³„ ê²°ì •: ì½œë°± ì‹œì  ì¬ê³  ì°¨ê° (ë©˜í† ë‹˜ ê¶Œì¥ ë°©ì‹)**

**ì„ íƒí•œ ë°©ì‹: ë°©ì‹ B (ì½œë°± ì‹œì  ì°¨ê°)**
```
ì£¼ë¬¸ ìƒì„± â†’ ì¬ê³  ê²€ì¦ë§Œ â†’ PG ìš”ì²­ â†’ ì½œë°± ì„±ê³µ ì‹œ ì¬ê³  ì°¨ê°
```

**ì¥ì :**
- âœ… PG ì¥ì•  ì‹œ ì¬ê³  ë¬¶ì´ì§€ ì•ŠìŒ (GMV ë³´í˜¸)
- âœ… ì‹œìŠ¤í…œ ë‹¨ìˆœ (ì¬ê³  ì›ë³µ ë¡œì§ ë¶ˆí•„ìš”)
- âœ… ì¥ì•  ê²©ë¦¬ (PG ì‹¤íŒ¨ê°€ ì¬ê³ ì— ì˜í–¥ ì—†ìŒ)

**ë‹¨ì :**
- âš ï¸ ì½œë°± íƒ€ì´ë°ì— ì¬ê³  ë¶€ì¡± ê°€ëŠ¥ (â†’ PG ì·¨ì†Œ + CS ì²˜ë¦¬)

---

### 8. Resilience4j ì„¤ì •

#### ğŸ“ `application.yml`
**ìœ„ì¹˜:** `apps/commerce-api/src/main/resources/application.yml`

```yaml
pg:
  base-url: http://localhost:8082

resilience4j:
  circuitbreaker:
    instances:
      pgCircuit:
        # TIME_BASED: ì‹œê°„ ê¸°ë°˜ ìŠ¬ë¼ì´ë”© ìœˆë„ìš°
        sliding-window-type: TIME_BASED
        sliding-window-size: 30  # 30ì´ˆ ë™ì•ˆì˜ í˜¸ì¶œ ë°ì´í„°

        # ìµœì†Œ í˜¸ì¶œ íšŸìˆ˜
        minimum-number-of-calls: 20

        # ì‹¤íŒ¨ìœ¨ ì„ê³„ê°’: 60%
        failure-rate-threshold: 60

        # Slow Call ì„¤ì •
        slow-call-duration-threshold: 2s
        slow-call-rate-threshold: 50

        # Circuit Open ìƒíƒœ ìœ ì§€ ì‹œê°„
        wait-duration-in-open-state: 10s

        # Half-Open í…ŒìŠ¤íŠ¸ í˜¸ì¶œ ìˆ˜
        permitted-number-of-calls-in-half-open-state: 5

        # ìë™ ì „í™˜
        automatic-transition-from-open-to-half-open-enabled: true

        # ê¸°ë¡í•  ì˜ˆì™¸ (ë„¤íŠ¸ì›Œí¬/ì„œë²„ ì—ëŸ¬ë§Œ)
        record-exceptions:
          - java.net.SocketTimeoutException
          - org.springframework.web.client.HttpServerErrorException
          - feign.RetryableException

        # ë¬´ì‹œí•  ì˜ˆì™¸ (4xx í´ë¼ì´ì–¸íŠ¸ ì—ëŸ¬)
        ignore-exceptions:
          - org.springframework.web.client.HttpClientErrorException

        register-health-indicator: true

  timelimiter:
    instances:
      pgTimeLimiter:
        timeout-duration: 3s
```

**ì„¤ì •ê°’ ì„ íƒ ê·¼ê±°:**

| ì„¤ì • | ê°’ | ì´ìœ  |
|------|-----|------|
| `failure-rate-threshold` | 60% | PG ì •ìƒ ì„±ê³µë¥  60%, 60% ë¯¸ë§Œ ì‹œ ë¹„ì •ìƒ íŒë‹¨ |
| `slow-call-duration-threshold` | 2s | ì •ìƒ ì§€ì—° 100~500ms, 2ì´ˆ ì´ˆê³¼ëŠ” ëŠë¦¼ |
| `wait-duration-in-open-state` | 10s | PG ë³µêµ¬ ëŒ€ê¸° ì‹œê°„ |
| `timeout-duration` | 3s | ì½œë°± ë°©ì‹ì´ë¯€ë¡œ 3ì´ˆ ë‚´ ì‘ë‹µ ì ‘ìˆ˜ë§Œ í™•ì¸ |
| `minimum-number-of-calls` | 20 | ì¶©ë¶„í•œ ìƒ˜í”Œë¡œ ì‹¤íŒ¨ìœ¨ ê³„ì‚° |

---

### 9. ì—ëŸ¬ íƒ€ì… ì¶”ê°€

#### ğŸ“ `ErrorType.kt`
**ìœ„ì¹˜:** `apps/commerce-api/src/main/kotlin/com/loopers/support/error/ErrorType.kt`

```kotlin
// ê²°ì œ ê´€ë ¨ ì—ëŸ¬
PAYMENT_NOT_FOUND(HttpStatus.NOT_FOUND, "PAYMENT_001", "ê²°ì œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."),
INVALID_PAYMENT_STATUS(HttpStatus.BAD_REQUEST, "PAYMENT_002", "ê²°ì œ ìƒíƒœë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."),
PAYMENT_UNAVAILABLE(HttpStatus.SERVICE_UNAVAILABLE, "PAYMENT_003", "í˜„ì¬ ê²°ì œ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."),
PG_NOT_AVAILABLE(HttpStatus.SERVICE_UNAVAILABLE, "PAYMENT_004", "ê²°ì œ ëŒ€í–‰ì‚¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."),
PG_REQUEST_FAILED(HttpStatus.BAD_GATEWAY, "PAYMENT_005", "ê²°ì œ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."),
PG_TIMEOUT(HttpStatus.GATEWAY_TIMEOUT, "PAYMENT_006", "ê²°ì œ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤."),
PAYMENT_ALREADY_PROCESSED(HttpStatus.CONFLICT, "PAYMENT_007", "ì´ë¯¸ ì²˜ë¦¬ëœ ê²°ì œì…ë‹ˆë‹¤."),
```

---

### 10. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

#### ğŸ“ `docker/01-schema.sql`
```sql
CREATE TABLE IF NOT EXISTS commerce_payments (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    order_id BIGINT NOT NULL,
    amount DECIMAL(15, 2) NOT NULL,
    payment_method VARCHAR(20) NOT NULL,
    status VARCHAR(20) NOT NULL,
    transaction_key VARCHAR(100),
    card_type VARCHAR(20),
    card_no VARCHAR(20),
    failure_reason VARCHAR(500),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**í…Œì´ë¸”ëª… ì¶©ëŒ ë°©ì§€:**
- pg-simulator: `payments` í…Œì´ë¸”
- commerce-api: `commerce_payments` í…Œì´ë¸”

---

### 11. HTTP í…ŒìŠ¤íŠ¸ íŒŒì¼

#### ğŸ“ `http/commerce-api/commerce-api.http`
- âœ… ì£¼ë¬¸ ìƒì„± (ì¹´ë“œ ê²°ì œ) API í…ŒìŠ¤íŠ¸ íŒŒì¼

#### ğŸ“ `http/pg-simulator/payments.http`
- âœ… PG Simulator API í…ŒìŠ¤íŠ¸ íŒŒì¼

---

## ğŸš§ ë¯¸ì™„ë£Œ ì‘ì—… (TODO)

### 1. ìŠ¤ì¼€ì¤„ëŸ¬ ê¸°ë°˜ ì£¼ë¬¸ ëŒ€ì‚¬ (ë³µêµ¬ ë¡œì§)
**ëª©ì :** ì½œë°± ëˆ„ë½ ì¼€ì´ìŠ¤ ë³µêµ¬

**í•„ìš” êµ¬í˜„:**
```kotlin
@Component
class PaymentReconciliationScheduler {
    @Scheduled(fixedDelay = 60000) // 1ë¶„ë§ˆë‹¤
    fun reconcileStaleOrders() {
        // 10ë¶„ ì´ìƒ PENDINGì¸ ì£¼ë¬¸ ì¡°íšŒ
        // PG ìƒíƒœ ì§ì ‘ ì¡°íšŒ
        // ì„±ê³µì´ë©´ ì¬ê³  ì°¨ê° + ì£¼ë¬¸ ì™„ë£Œ
        // ì‹¤íŒ¨ë©´ ì£¼ë¬¸ ì‹¤íŒ¨ ì²˜ë¦¬
    }
}
```

**íŒŒì¼ ìœ„ì¹˜:** `apps/commerce-api/src/main/kotlin/com/loopers/domain/payment/PaymentReconciliationScheduler.kt`

**í•„ìš” ì‘ì—…:**
- [ ] `@EnableScheduling` ì¶”ê°€
- [ ] `OrderRepository.findByStatusAndCreatedAtBefore()` ë©”ì„œë“œ ì¶”ê°€
- [ ] PG ìƒíƒœ ì¡°íšŒ ë¡œì§
- [ ] ë³µêµ¬ ì²˜ë¦¬ ë¡œì§

---

### 2. ì¬ê³  ë¶€ì¡± ì‹œ PG ì·¨ì†Œ ìš”ì²­

**í˜„ì¬ ìƒíƒœ:**
- `PaymentCallbackService`ì—ì„œ ì¬ê³  ë¶€ì¡± ì˜ˆì™¸ ì²˜ë¦¬ë§Œ êµ¬í˜„
- PG ì·¨ì†Œ API í˜¸ì¶œì€ TODO ì£¼ì„ìœ¼ë¡œ ë‚¨ê²¨ë‘ 

**í•„ìš” êµ¬í˜„:**
```kotlin
// PgSimulatorClientì— ì¶”ê°€
@PostMapping("/api/v1/payments/{transactionKey}/cancel")
fun cancelPayment(
    @RequestHeader("X-USER-ID") userId: String,
    @PathVariable transactionKey: String
): PgDto.CancelResponse
```

```kotlin
// PaymentCallbackServiceì—ì„œ í˜¸ì¶œ
catch (e: Exception) {
    pgClient.cancelPayment(userId, callback.transactionKey)
    payment.markAsFailed("ì¬ê³  ë¶€ì¡±")
    order.fail()
    // TODO: CS íŒ€ ì•Œë¦¼
}
```

---

### 3. í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±

**í˜„ì¬ ìƒíƒœ:**
- `PaymentTest.kt` íŒŒì¼ë§Œ ì¡´ì¬ (ë‚´ìš© ë¹„ì–´ìˆìŒ)

**í•„ìš” í…ŒìŠ¤íŠ¸:**
- [ ] Payment ì—”í‹°í‹° ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- [ ] PaymentService í†µí•© í…ŒìŠ¤íŠ¸
- [ ] PaymentCallbackService í†µí•© í…ŒìŠ¤íŠ¸
- [ ] CircuitBreaker ë™ì‘ í…ŒìŠ¤íŠ¸
- [ ] Fallback ë™ì‘ í…ŒìŠ¤íŠ¸

---

### 4. ProductService ë©”ì„œë“œ ì¶”ê°€

**í•„ìš” ë©”ì„œë“œ:**
```kotlin
// ProductService.kt
fun decreaseStockByOrder(order: Order) {
    order.items.forEach { item ->
        val product = productRepository.findByIdWithLock(item.productId)
        product.decreaseStock(item.quantity)
    }
}
```

**í˜„ì¬ ìƒíƒœ:**
- `PaymentCallbackService`ì—ì„œ í˜¸ì¶œí•˜ì§€ë§Œ êµ¬í˜„ ì—¬ë¶€ í™•ì¸ í•„ìš”

---

### 5. Actuator ì„¤ì • ë° ëª¨ë‹ˆí„°ë§

**í•„ìš” ì‘ì—…:**
- [ ] Actuator health ì—”ë“œí¬ì¸íŠ¸ í™œì„±í™”
- [ ] CircuitBreaker ìƒíƒœ ëª¨ë‹ˆí„°ë§
- [ ] ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì„¤ì •

---

## ğŸ“Š ì „ì²´ ì•„í‚¤í…ì²˜ í”Œë¡œìš°

### ì •ìƒ ê²°ì œ í”Œë¡œìš°
```
1. ì‚¬ìš©ì ì£¼ë¬¸ ìš”ì²­
   â†“
2. OrderService.createOrderWithCardPayment()
   - ì¬ê³  ê²€ì¦ë§Œ (ì°¨ê° X)
   - Order ìƒì„± (PENDING)
   â†“
3. PaymentService.requestCardPayment()
   - PG Strategy ì„ íƒ
   - PG API í˜¸ì¶œ
   - Payment ìƒì„± (PENDING)
   - CircuitBreaker, TimeLimiter ì ìš©
   â†“
4. ì‚¬ìš©ìì—ê²Œ "ê²°ì œ ì§„í–‰ ì¤‘" ì‘ë‹µ
   â†“
5. PG Simulator ê²°ì œ ì²˜ë¦¬ (1~5ì´ˆ)
   â†“
6. PG Callback ì „ì†¡
   â†“
7. PaymentCallbackService.handlePaymentCallback()
   - ë©±ë“±ì„± ì²´í¬
   - ì¬ê³  ì°¨ê°
   - Payment.markAsSuccess()
   - Order.complete()
   â†“
8. ê²°ì œ ì™„ë£Œ
```

### ì¥ì•  ì‹œë‚˜ë¦¬ì˜¤: PG Timeout
```
1. OrderService.createOrderWithCardPayment()
   â†“
2. PaymentService.requestCardPayment()
   - PG API í˜¸ì¶œ
   - 3ì´ˆ íƒ€ì„ì•„ì›ƒ ë°œìƒ
   â†“
3. TimeLimiterê°€ TimeoutException ë°œìƒ
   â†“
4. PaymentFallback ì‹¤í–‰
   - Payment.createFailedPayment() (FAILED)
   - Order.fail()
   - ì¬ê³  ê·¸ëŒ€ë¡œ ìœ ì§€
   â†“
5. ì‚¬ìš©ìì—ê²Œ ì—ëŸ¬ ì‘ë‹µ
   "í˜„ì¬ ì¹´ë“œ ê²°ì œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
```

### ì¥ì•  ì‹œë‚˜ë¦¬ì˜¤: CircuitBreaker Open
```
1. ì—°ì† 20íšŒ í˜¸ì¶œ ì¤‘ 12íšŒ ì´ìƒ ì‹¤íŒ¨
   â†“
2. CircuitBreakerê°€ OPEN ìƒíƒœë¡œ ì „í™˜
   â†“
3. ì´í›„ ìš”ì²­ì€ PG í˜¸ì¶œ ì—†ì´ ì¦‰ì‹œ Fallback ì‹¤í–‰
   â†“
4. 10ì´ˆ í›„ HALF-OPEN ì „í™˜
   â†“
5. í…ŒìŠ¤íŠ¸ í˜¸ì¶œ 5íšŒ ì¤‘ ì„±ê³µ ì‹œ CLOSED ë³µêµ¬
```

---

## ğŸ—‚ï¸ ì£¼ìš” íŒŒì¼ ìœ„ì¹˜ ì •ë¦¬

### ë„ë©”ì¸ ë ˆì´ì–´
```
apps/commerce-api/src/main/kotlin/com/loopers/domain/
â”œâ”€â”€ payment/
â”‚   â”œâ”€â”€ Payment.kt                        # ì—”í‹°í‹°
â”‚   â”œâ”€â”€ PaymentStatus.kt                  # Enum
â”‚   â”œâ”€â”€ PaymentMethod.kt                  # Enum
â”‚   â”œâ”€â”€ PaymentRepository.kt              # ì¸í„°í˜ì´ìŠ¤
â”‚   â”œâ”€â”€ PaymentService.kt                 # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
â”‚   â”œâ”€â”€ PaymentCallbackService.kt         # ì½œë°± ì²˜ë¦¬
â”‚   â”œâ”€â”€ PaymentCallbackDto.kt             # DTO
â”‚   â””â”€â”€ strategy/
â”‚       â”œâ”€â”€ PgStrategy.kt                 # ì „ëµ ì¸í„°í˜ì´ìŠ¤
â”‚       â””â”€â”€ SimulatorPgStrategy.kt        # êµ¬í˜„ì²´
â””â”€â”€ order/
    â””â”€â”€ OrderService.kt                   # ì¹´ë“œ ê²°ì œ ì£¼ë¬¸ ì¶”ê°€
```

### ì¸í”„ë¼ ë ˆì´ì–´
```
apps/commerce-api/src/main/kotlin/com/loopers/infrastructure/
â”œâ”€â”€ payment/
â”‚   â”œâ”€â”€ PaymentJpaRepository.kt           # JPA Repository
â”‚   â””â”€â”€ PaymentRepositoryImpl.kt          # êµ¬í˜„ì²´
â””â”€â”€ pg/
    â”œâ”€â”€ PgSimulatorClient.kt              # FeignClient
    â”œâ”€â”€ PgClientConfig.kt                 # Feign ì„¤ì •
    â””â”€â”€ PgDto.kt                          # DTO
```

### API ë ˆì´ì–´
```
apps/commerce-api/src/main/kotlin/com/loopers/interfaces/api/
â””â”€â”€ payment/
    â””â”€â”€ PaymentCallbackController.kt      # ì½œë°± ì—”ë“œí¬ì¸íŠ¸
```

### ì„¤ì • íŒŒì¼
```
apps/commerce-api/src/main/kotlin/com/loopers/config/
â””â”€â”€ FeignConfig.kt                        # @EnableFeignClients

apps/commerce-api/src/main/resources/
â””â”€â”€ application.yml                       # Resilience4j, PG ì„¤ì •
```

---

## ğŸ¯ ë‹¤ìŒ ìš°ì„ ìˆœìœ„ ì‘ì—…

### 1. ì¦‰ì‹œ í•„ìš” (High Priority)
- [ ] **ìŠ¤ì¼€ì¤„ëŸ¬ ê¸°ë°˜ ë³µêµ¬ ë¡œì§ êµ¬í˜„** - ì½œë°± ëˆ„ë½ ëŒ€ì‘
- [ ] **ì¬ê³  ë¶€ì¡± ì‹œ PG ì·¨ì†Œ API êµ¬í˜„** - ì™„ì „í•œ ë¡¤ë°± ì²˜ë¦¬
- [ ] **í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±** - ì •ìƒ/ì¥ì•  ì‹œë‚˜ë¦¬ì˜¤ ê²€ì¦

### 2. ì¶”í›„ ê°œì„  (Medium Priority)
- [ ] **Retry ì •ì±… ê²€í† ** - í•„ìš” ì‹œ ì¶”ê°€
- [ ] **Actuator ëª¨ë‹ˆí„°ë§ ì„¤ì •** - Circuit ìƒíƒœ ì¶”ì 
- [ ] **ë¡œê¹… ê°œì„ ** - ì£¼ìš” í”Œë¡œìš°ë³„ ë¡œê·¸ ë³´ê°•

### 3. ì„ íƒ ì‚¬í•­ (Low Priority)
- [ ] **PG ì½œë°± ë³´ì•ˆ ê²€ì¦** - ì„œëª…, IP í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸
- [ ] **CS ì•Œë¦¼ ì‹œìŠ¤í…œ** - ì¬ê³  ë¶€ì¡± ë“± ì•Œë¦¼
- [ ] **ëŒ€ì‹œë³´ë“œ êµ¬ì¶•** - Grafana, Prometheus ì—°ë™

---

## ğŸ“ ì°¸ê³  ë¬¸ì„œ
- [week6-resilience-blog.md](.codeguide/round6/week6-resilience-blog.md) - êµ¬í˜„ ê°€ì´ë“œ ë¸”ë¡œê·¸
- [mentor_comment.md](.codeguide/round6/mentor_comment.md) - ë©˜í† ë‹˜ ì½”ë©˜íŠ¸
- [Failure-Ready Systems.md](.codeguide/round6/Failure-Ready%20Systems.md) - ìˆ˜ì—… ìë£Œ

---

**ì‘ì„± ì¼ì‹œ:** 2025-12-04
**ì‘ì„±ì:** Claude Code (ìš”ì²­: ì‚¬ìš©ì)
**ë¬¸ì„œ ë²„ì „:** 1.0
