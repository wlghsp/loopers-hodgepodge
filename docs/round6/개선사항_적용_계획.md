# Code Quality ê°œì„ ì‚¬í•­ ì ìš© ê³„íš

> ğŸ“… ì‘ì„±ì¼: 2025-12-04
>
> ğŸ¯ Round 5 ë¦¬ë·° ê¸°ë°˜ ê°œì„ ì‚¬í•­ ì¤‘ ì ìš©í•  í•­ëª© ì •ë¦¬

---

## âœ… ì¦‰ì‹œ ì ìš© í•­ëª© (High Priority)

### 1. Email Pattern ì„±ëŠ¥ ê°œì„  â­â­â­

**íŒŒì¼:** `apps/commerce-api/src/main/kotlin/com/loopers/domain/shared/Email.kt`

**ì ìš© ë‚´ìš©:**
```kotlin
@Embeddable
class Email(email: String) {

    @Column(name = "email", nullable = false, length = 100, unique = true)
    var email: String = email
        protected set

    init {
        require(EMAIL_PATTERN.matcher(email).matches()) {
            "ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤: $email"
        }
    }

    companion object {
        private val EMAIL_PATTERN: Pattern = Pattern.compile(
            "^[a-zA-Z0-9_+&*-]+(?:\\.[a-zA-Z0-9_+&*-]+)*@(?:[a-zA-Z0-9-]+\\.)+[a-zA-Z]{2,7}$"
        )
    }

    override fun equals(other: Any?): Boolean {
        if (this === other) return true
        if (other !is Email) return false
        return email == other.email
    }

    override fun hashCode(): Int = email.hashCode()
}
```

---

### 2. Null ì•ˆì „ì„± ê°œì„  â­â­â­

#### 2-1. PaymentService.kt

**íŒŒì¼:** `apps/commerce-api/src/main/kotlin/com/loopers/domain/payment/PaymentService.kt`

**ë³€ê²½:**
```kotlin
// Payment ì—”í‹°í‹° ìƒì„± (PENDING ìƒíƒœ)
val payment = Payment.createCardPayment(
    orderId = order.id ?: throw CoreException(
        ErrorType.ORDER_NOT_FOUND,
        "ì£¼ë¬¸ IDê°€ ì—†ìŠµë‹ˆë‹¤. ì£¼ë¬¸ì´ ì˜ì†í™”ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
    ),
    amount = order.finalAmount,
    transactionKey = pgResponse.transactionKey,
    cardType = cardType,
    cardNo = cardNo
)
```

#### 2-2. PaymentCallbackService.kt

**íŒŒì¼:** `apps/commerce-api/src/main/kotlin/com/loopers/domain/payment/PaymentCallbackService.kt`

**í™•ì¸ í•„ìš”:**
- `payment.id` ì‚¬ìš©í•˜ëŠ” ê³³ null ì²˜ë¦¬ í™•ì¸

---

### 3. ë¯¸ì‚¬ìš© Import ì •ë¦¬ â­â­

**ëŒ€ìƒ íŒŒì¼:**
- `PaymentService.kt`
- `PaymentCallbackService.kt`
- `SimulatorPgStrategy.kt`
- `Payment.kt`
- `PgSimulatorClient.kt`

**ì‹¤í–‰:**
```
IntelliJ: Ctrl+Alt+O (Windows/Linux) / Cmd+Option+O (Mac)
ë˜ëŠ” Code > Optimize Imports
```

---

### 4. PaymentCallbackDto ê²€ì¦ ì¶”ê°€ â­â­

**íŒŒì¼:** `apps/commerce-api/src/main/kotlin/com/loopers/domain/payment/PaymentCallbackDto.kt`

**ì ìš© ë‚´ìš©:**
```kotlin
data class PaymentCallbackDto(
    val transactionKey: String,
    val status: String,
    val reason: String?
) {
    init {
        require(transactionKey.isNotBlank()) {
            "ê±°ë˜ í‚¤ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤"
        }
        require(transactionKey.length <= 100) {
            "ê±°ë˜ í‚¤ëŠ” 100ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
        }
        require(status.isNotBlank()) {
            "ê²°ì œ ìƒíƒœëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤"
        }
    }

    fun isSuccess(): Boolean = status == "SUCCESS"
}
```

---

## ğŸ”§ ê²€í†  í›„ ì ìš© í•­ëª©

### 1. Brand FK ì œì•½ì¡°ê±´ ì¶”ê°€ (ì˜µì…˜ B ì„ íƒ) âœ…

**ê²°ì •:** DB FK ì œì•½ì¡°ê±´ìœ¼ë¡œ ë¬´ê²°ì„± ë³´ì¥

**íŒŒì¼:** `docker/01-schema.sql`

**ì¶”ê°€ ë‚´ìš©:**
```sql
-- Brand FK ì œì•½ì¡°ê±´ ì¶”ê°€
ALTER TABLE products
ADD CONSTRAINT fk_products_brand
FOREIGN KEY (brand_id) REFERENCES brands(id)
ON DELETE RESTRICT
ON UPDATE CASCADE;
```

**ì´ì :**
- DB ë ˆë²¨ì—ì„œ ë¬´ê²°ì„± ë³´ì¥
- ì¡´ì¬í•˜ì§€ ì•ŠëŠ” brandIdë¡œ Product ìƒì„± ë¶ˆê°€
- ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ ë‹¨ìˆœí™”

**ì£¼ì˜:**
- Brand ì‚­ì œ ì‹œ Productê°€ ìˆìœ¼ë©´ ì‚­ì œ ë¶ˆê°€ (ON DELETE RESTRICT)
- í•„ìš”ì‹œ soft delete íŒ¨í„´ ê³ ë ¤

---

### 2. ì¹´ë“œ ë²ˆí˜¸ ë§ˆìŠ¤í‚¹ (ì—…ê³„ í‘œì¤€ ì ìš©) âœ…

**ê²°ì •:** ì‹¤ë¬´ì—ì„œ ì¼ë°˜ì ìœ¼ë¡œ ì ìš©í•˜ëŠ” íŒ¨í„´ì´ë¯€ë¡œ êµ¬í˜„

**íŒŒì¼:** `apps/commerce-api/src/main/kotlin/com/loopers/domain/payment/CardNumber.kt` (ìƒˆ íŒŒì¼)

**êµ¬í˜„:**
```kotlin
package com.loopers.domain.payment

import jakarta.persistence.Column
import jakarta.persistence.Embeddable

/**
 * ì¹´ë“œ ë²ˆí˜¸ Value Object
 * ë³´ì•ˆì„ ìœ„í•´ ë§ˆìŠ¤í‚¹ëœ ë²ˆí˜¸ë§Œ ì €ì¥
 */
@Embeddable
data class CardNumber private constructor(
    @Column(name = "card_no_masked", length = 20)
    val maskedNumber: String
) {
    companion object {
        /**
         * ì›ë³¸ ì¹´ë“œ ë²ˆí˜¸ë¥¼ ë§ˆìŠ¤í‚¹í•˜ì—¬ CardNumber ìƒì„±
         *
         * @param plainCardNo ì›ë³¸ ì¹´ë“œ ë²ˆí˜¸ (ì˜ˆ: "1234567890123456")
         * @return ë§ˆìŠ¤í‚¹ëœ CardNumber (ì˜ˆ: "************3456")
         */
        fun from(plainCardNo: String): CardNumber {
            require(plainCardNo.isNotBlank()) {
                "ì¹´ë“œ ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤"
            }
            require(plainCardNo.length >= 4) {
                "ì¹´ë“œ ë²ˆí˜¸ëŠ” ìµœì†Œ 4ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤"
            }

            val masked = if (plainCardNo.length <= 4) {
                "****"
            } else {
                "*".repeat(plainCardNo.length - 4) + plainCardNo.takeLast(4)
            }

            return CardNumber(masked)
        }

        /**
         * ì´ë¯¸ ë§ˆìŠ¤í‚¹ëœ ë²ˆí˜¸ë¡œ ìƒì„± (DB ì¡°íšŒ ì‹œ ì‚¬ìš©)
         */
        fun fromMasked(maskedNumber: String): CardNumber {
            return CardNumber(maskedNumber)
        }
    }

    override fun toString(): String = maskedNumber
}
```

**Payment.kt ìˆ˜ì •:**
```kotlin
@Entity
@Table(name = "commerce_payments")
class Payment(
    orderId: Long,
    amount: Money,
    paymentMethod: PaymentMethod = PaymentMethod.POINT,
    transactionKey: String? = null,
    cardType: String? = null,
    cardNumber: CardNumber? = null,  // String â†’ CardNumber
) : BaseEntity() {

    // ... ê¸°ì¡´ í•„ë“œë“¤ ...

    @Embedded
    var cardNumber: CardNumber? = cardNumber
        protected set

    // ... ê¸°ì¡´ ë©”ì„œë“œë“¤ ...

    companion object {
        fun createCardPayment(
            orderId: Long,
            amount: Money,
            transactionKey: String,
            cardType: String,
            cardNo: String,  // ì›ë³¸ ì¹´ë“œ ë²ˆí˜¸ ë°›ìŒ
        ): Payment {
            return Payment(
                orderId = orderId,
                amount = amount,
                paymentMethod = PaymentMethod.CARD,
                transactionKey = transactionKey,
                cardType = cardType,
                cardNumber = CardNumber.from(cardNo),  // ë§ˆìŠ¤í‚¹ ì²˜ë¦¬
            )
        }

        fun createFailedPayment(
            orderId: Long,
            amount: Money,
            reason: String,
        ): Payment {
            return Payment(
                orderId = orderId,
                amount = amount,
            ).apply {
                status = PaymentStatus.FAILED
                failureReason = reason
            }
        }
    }
}
```

**PaymentService.kt ìˆ˜ì •:**
```kotlin
// PG ê²°ì œ ìš”ì²­
val pgRequest = PgDto.PaymentRequest(
    orderId = order.id.toString(),
    cardType = PgDto.CardTypeDto.valueOf(cardType),
    cardNo = cardNo,  // PGì—ëŠ” ì›ë³¸ ì „ì†¡
    amount = order.finalAmount.amount,
    callbackUrl = "http://localhost:8080/api/v1/payments/callback"
)

// Payment ì €ì¥ ì‹œ ìë™ ë§ˆìŠ¤í‚¹
val payment = Payment.createCardPayment(
    orderId = order.id ?: throw CoreException(...),
    amount = order.finalAmount,
    transactionKey = pgResponse.transactionKey,
    cardType = cardType,
    cardNo = cardNo  // CardNumber.from()ì—ì„œ ìë™ ë§ˆìŠ¤í‚¹
)
```

**ì´ì :**
- ì—…ê³„ í‘œì¤€ ë³´ì•ˆ ê´€í–‰
- DBì— ë¯¼ê° ì •ë³´ ì €ì¥ ì•ˆ í•¨
- ë¡œê·¸ ë…¸ì¶œ ìœ„í—˜ ê°ì†Œ
- Value Object íŒ¨í„´ í•™ìŠµ

---

## â¸ï¸ ë³´ë¥˜ í•­ëª©

### Payment ë„ë©”ì¸ ìƒì„¸ ê²€ì¦ (ê³¼ë„í•¨)

**ë³´ë¥˜ ì´ìœ :**
- í˜„ì¬ ê²€ì¦ ë ˆë²¨ë¡œ ì¶©ë¶„
- PG ì‹œë®¬ë ˆì´í„° ì—°ë™ì´ë¯€ë¡œ ê³¼ë„í•œ ê²€ì¦ ë¶ˆí•„ìš”
- í•„ìš” ì‹œ ì¶”í›„ ì¶”ê°€ ê°€ëŠ¥

**ë³´ë¥˜ëœ ê²€ì¦:**
```kotlin
// ì ìš©í•˜ì§€ ì•ŠìŒ
require(orderId > 0) { "ì£¼ë¬¸ IDëŠ” 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤" }
require(amount.amount > 0L) { "ê²°ì œ ê¸ˆì•¡ì€ 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤" }
```

---

## ğŸ“‹ ì‘ì—… ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì¦‰ì‹œ ì ìš© (ì˜¤ëŠ˜)
- [ ] Email.kt Pattern companion object ì´ë™
- [ ] PaymentService.kt null ì•ˆì „ì„± ê°œì„ 
- [ ] PaymentCallbackDto ê²€ì¦ ì¶”ê°€
- [ ] ì „ì²´ í”„ë¡œì íŠ¸ ë¯¸ì‚¬ìš© import ì •ë¦¬

### DB ìŠ¤í‚¤ë§ˆ ìˆ˜ì • (ì˜¤ëŠ˜)
- [ ] docker/01-schema.sqlì— Brand FK ì œì•½ì¡°ê±´ ì¶”ê°€
- [ ] DB ì¬ì‹œì‘ ë° í…ŒìŠ¤íŠ¸

### ì¹´ë“œ ë²ˆí˜¸ ë§ˆìŠ¤í‚¹ êµ¬í˜„ (ì˜¤ëŠ˜/ë‚´ì¼)
- [ ] CardNumber.kt Value Object ìƒì„±
- [ ] Payment.kt ìˆ˜ì • (cardNo â†’ cardNumber)
- [ ] PaymentService.kt ìˆ˜ì •
- [ ] í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±
- [ ] ê¸°ì¡´ í…ŒìŠ¤íŠ¸ ìˆ˜ì •

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ê³„íš

### 1. Email Pattern í…ŒìŠ¤íŠ¸
```kotlin
@Test
fun `ìœ íš¨í•œ ì´ë©”ì¼ í˜•ì‹`() {
    val email = Email("test@example.com")
    assertThat(email.email).isEqualTo("test@example.com")
}

@Test
fun `ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ ì˜ˆì™¸ ë°œìƒ`() {
    assertThrows<IllegalArgumentException> {
        Email("invalid-email")
    }
}
```

### 2. CardNumber ë§ˆìŠ¤í‚¹ í…ŒìŠ¤íŠ¸
```kotlin
@Test
fun `ì¹´ë“œ ë²ˆí˜¸ ë§ˆìŠ¤í‚¹ - 16ìë¦¬`() {
    val cardNumber = CardNumber.from("1234567890123456")
    assertThat(cardNumber.maskedNumber).isEqualTo("************3456")
}

@Test
fun `ì¹´ë“œ ë²ˆí˜¸ ë§ˆìŠ¤í‚¹ - 4ìë¦¬`() {
    val cardNumber = CardNumber.from("1234")
    assertThat(cardNumber.maskedNumber).isEqualTo("****")
}

@Test
fun `ì¹´ë“œ ë²ˆí˜¸ ë¹ˆ ë¬¸ìì—´ ì˜ˆì™¸`() {
    assertThrows<IllegalArgumentException> {
        CardNumber.from("")
    }
}
```

### 3. Brand FK ì œì•½ì¡°ê±´ í…ŒìŠ¤íŠ¸
```kotlin
@Test
fun `ì¡´ì¬í•˜ì§€ ì•ŠëŠ” Brandë¡œ Product ìƒì„± ì‹œ ì˜ˆì™¸`() {
    assertThrows<DataIntegrityViolationException> {
        productJpaRepository.save(
            Product("ìƒí’ˆ", "ì„¤ëª…", Money.of(1000), Stock.of(10), 999L)
        )
    }
}
```

---

## ğŸš€ ì˜ˆìƒ ì‘ì—… ì‹œê°„

| ì‘ì—… | ì˜ˆìƒ ì‹œê°„ |
|------|-----------|
| Email Pattern ê°œì„  | 5ë¶„ |
| Null ì•ˆì „ì„± ê°œì„  | 10ë¶„ |
| Import ì •ë¦¬ | 5ë¶„ |
| PaymentCallbackDto ê²€ì¦ | 5ë¶„ |
| Brand FK ì œì•½ì¡°ê±´ | 10ë¶„ |
| CardNumber VO êµ¬í˜„ | 30ë¶„ |
| Payment ìˆ˜ì • | 20ë¶„ |
| í…ŒìŠ¤íŠ¸ ì‘ì„± | 30ë¶„ |
| **ì´ê³„** | **ì•½ 2ì‹œê°„** |

---

## ğŸ“Œ ì£¼ì˜ì‚¬í•­

### 1. DB ìŠ¤í‚¤ë§ˆ ë³€ê²½
- FK ì¶”ê°€ ì‹œ ê¸°ì¡´ ë°ì´í„° ì •í•©ì„± í™•ì¸ í•„ìš”
- ë¡œì»¬ ê°œë°œ í™˜ê²½ DB ì´ˆê¸°í™” ê¶Œì¥

### 2. ì¹´ë“œ ë²ˆí˜¸ ë§ˆìŠ¤í‚¹
- PG API í˜¸ì¶œ ì‹œì—ëŠ” ì›ë³¸ ì¹´ë“œ ë²ˆí˜¸ ì‚¬ìš©
- DB ì €ì¥ ì‹œì—ë§Œ ë§ˆìŠ¤í‚¹ëœ ë²ˆí˜¸ ì €ì¥
- ë¡œê·¸ì—ë„ ë§ˆìŠ¤í‚¹ëœ ë²ˆí˜¸ë§Œ ì¶œë ¥ë˜ë„ë¡ ì£¼ì˜

### 3. ê¸°ì¡´ ì½”ë“œ ì˜í–¥
- Payment í•„ë“œ ë³€ê²½ìœ¼ë¡œ ì¸í•œ ê¸°ì¡´ ì½”ë“œ ìˆ˜ì • í•„ìš”
- í…ŒìŠ¤íŠ¸ ì½”ë“œ ì—…ë°ì´íŠ¸ í•„ìˆ˜

---

**ì‘ì„±ì¼:** 2025-12-04
**ìµœì¢… ì—…ë°ì´íŠ¸:** 2025-12-04
