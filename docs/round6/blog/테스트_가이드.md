# 블로그 테스트 결과 캡처 가이드

## 사전 준비

1. **애플리케이션 실행**
   ```bash
   # commerce-api (포트 8080)
   ./gradlew :apps:commerce-api:bootRun
   
   # pg-simulator (포트 8082)
   ./gradlew :apps:pg-simulator:bootRun
   ```

2. **DB 접속 정보 확인**
   - H2 콘솔: http://localhost:8080/h2-console
   - JDBC URL: `jdbc:h2:mem:testdb`
   - Username: `sa`
   - Password: (비어있음)

---

## 1. 정상 결제 API (07-normal-payment-api.png)

### 테스트 방법

**카드 전액 결제:**
```http
POST http://localhost:8080/api/v1/orders
Content-Type: application/json
X-USER-ID: testuser01

{
  "items": [
    {
      "productId": 1,
      "quantity": 1
    }
  ],
  "cardType": "SAMSUNG",
  "cardNo": "1234-5678-9012-3456"
}
```

**포인트 사용 + 카드 결제:**
```http
POST http://localhost:8080/api/v1/orders
Content-Type: application/json
X-USER-ID: testuser01

{
  "items": [
    {
      "productId": 1,
      "quantity": 1
    }
  ],
  "usePoint": 3000,
  "cardType": "SAMSUNG",
  "cardNo": "1234-5678-9012-3456"
}
```

**포인트 전액 결제:**
```http
POST http://localhost:8080/api/v1/orders
Content-Type: application/json
X-USER-ID: testuser01

{
  "items": [
    {
      "productId": 1,
      "quantity": 1
    }
  ],
  "usePoint": 10000
}
```

**또는 IntelliJ HTTP Client 사용:**
```http
### 주문 생성 (포인트 사용 + 카드 결제)
POST http://localhost:8080/api/v1/orders
X-USER-ID: testuser01
Content-Type: application/json

{
  "items": [
    {
      "productId": 1,
      "quantity": 1
    }
  ],
  "usePoint": 3000,
  "cardType": "SAMSUNG",
  "cardNo": "1234-5678-9012-3456"
}
```

**캡처할 내용:**
- HTTP 요청/응답 전체
- 응답 JSON (orderId, payment 정보 포함)
- 응답 시간 (정상적으로 빠름)

---

## 2. 정상 결제 로그 (08-normal-payment-log.png)

### 테스트 방법

1. 위의 정상 결제 API 호출
2. 애플리케이션 로그 확인

**캡처할 내용:**
- `Requesting card payment for order: {orderId}` 로그
- `PG response received: transactionKey=...` 로그
- 콜백 수신 후 `Payment success: orderId=...` 로그
- 재고 차감 로그

**로그 위치:**
- IntelliJ 콘솔 또는 터미널 출력

---

## 3. 타임아웃 API 응답 (09-timeout-api.png)

### 테스트 방법

**옵션 1: PG Simulator 지연 설정 (권장)**

`apps/pg-simulator/src/main/kotlin/com/loopers/interfaces/api/payment/PaymentApi.kt` 수정:

```kotlin
@PostMapping
fun request(...) {
    // 기존: Thread.sleep((100..500L).random())
    Thread.sleep(5000L)  // 5초 지연 (타임아웃 발생)
    
    // ... 나머지 코드
}
```

**옵션 2: 네트워크 차단 (임시)**
- PG Simulator를 중지하거나 포트 차단

**HTTP 요청:**
```http
POST http://localhost:8080/api/v1/orders
X-USER-ID: testuser01
Content-Type: application/json

{
  "items": [{"productId": 1, "quantity": 1}],
  "cardType": "SAMSUNG",
  "cardNo": "1234-5678-9012-3456"
}
```

**캡처할 내용:**
- HTTP 요청
- 타임아웃 에러 응답 (500 또는 503)
- 응답 시간 (3초 이상)
- 에러 메시지

---

## 4. 타임아웃 로그 (10-timeout-log.png)

### 테스트 방법

1. 위의 타임아웃 API 호출
2. 애플리케이션 로그 확인

**캡처할 내용:**
- `Requesting card payment for order: {orderId}` 로그
- 타임아웃 예외 로그 (SocketTimeoutException 등)
- `Payment fallback triggered for order: {orderId}` 로그
- Payment 상태: PENDING (실패 처리 안 함)

**로그 위치:**
- IntelliJ 콘솔 또는 터미널 출력

---

## 5. 스케줄러 복구 로그 (11-scheduler-recovery.png)

### 테스트 방법

**1단계: 콜백 누락 시나리오 생성**

**옵션 A: 콜백 URL 잘못 설정 (임시)**
`apps/commerce-api/src/main/kotlin/com/loopers/domain/payment/PaymentService.kt`:
```kotlin
callbackUrl = "http://invalid-url/api/v1/payments/callback"  // 잘못된 URL
```

**옵션 B: PG Simulator 콜백 전송 코드 주석 처리**
`apps/pg-simulator/src/main/kotlin/com/loopers/application/payment/PaymentApplicationService.kt`에서 콜백 전송 부분 주석 처리

**2단계: 주문 생성**
```http
POST http://localhost:8080/api/v1/orders
X-USER-ID: testuser01
Content-Type: application/json

{
  "items": [{"productId": 1, "quantity": 1}],
  "cardType": "SAMSUNG",
  "cardNo": "1234-5678-9012-3456"
}
```

**3단계: 스케줄러 주기 조정 (테스트용)**

`apps/commerce-api/src/main/kotlin/com/loopers/infrastructure/payment/PaymentRecoveryScheduler.kt`:
```kotlin
@Scheduled(fixedDelay = 10000)  // 10초마다 실행 (테스트용)
fun recoverPendingPayments() {
    val cutoffTime = LocalDateTime.now().minusMinutes(1)  // 1분 이상 (테스트용)
    // ...
}
```

**4단계: 대기 후 로그 확인**
- 10초 이상 대기
- 스케줄러 실행 로그 확인

**캡처할 내용:**
- `결제 복구 완료: orderId={orderId}` 로그
- PG 상태 조회 로그
- 재고 차감 로그
- Payment/Order 상태 변경 로그

---

## 6. Circuit Breaker OPEN (12-circuit-breaker-open.png)

### 테스트 방법

**1단계: PG Simulator 중지 또는 실패율 증가**

**옵션 A: PG Simulator 중지**
```bash
# pg-simulator 프로세스 종료
```

**옵션 B: 실패율 100%로 설정**
`apps/pg-simulator/src/main/kotlin/com/loopers/interfaces/api/payment/PaymentApi.kt`:
```kotlin
// 기존: if ((1..100).random() <= 40)
if (true) {  // 항상 실패
    throw CoreException(...)
}
```

**2단계: 연속 요청 (20회 이상)**
```bash
# 스크립트로 연속 호출
for i in {1..25}; do
  curl -X POST http://localhost:8080/api/v1/orders \
    -H "X-USER-ID: testuser01" \
    -H "Content-Type: application/json" \
    -d '{"items":[{"productId":1,"quantity":1}],"cardType":"SAMSUNG","cardNo":"1234-5678-9012-3456"}'
  sleep 0.5
done
```

**3단계: Circuit Breaker 상태 확인**

**Actuator 엔드포인트 (설정 필요):**
```yaml
# application.yml에 추가
management:
  endpoints:
    web:
      exposure:
        include: health,circuitbreakers
```

```http
GET http://localhost:8080/actuator/health
```

**또는 로그에서 확인:**
- `CircuitBreaker 'pgCircuit' changed state from CLOSED to OPEN` 로그

**캡처할 내용:**
- Circuit Breaker OPEN 상태 로그
- Actuator health 응답 (state: OPEN)
- Fallback 실행 로그 (PG 호출 없이 즉시 응답)

---

## 7. DB 상태 확인 (13-db-status.png)

### 테스트 방법

**H2 콘솔 접속:**
1. http://localhost:8080/h2-console
2. JDBC URL: `jdbc:h2:mem:testdb`
3. Username: `sa`
4. Password: (비어있음)

**주문 상태 확인:**
```sql
SELECT id, member_id, status, final_amount, created_at 
FROM orders 
ORDER BY created_at DESC 
LIMIT 10;
```

**결제 상태 확인:**
```sql
SELECT id, order_id, status, transaction_key, amount, created_at 
FROM commerce_payments 
ORDER BY created_at DESC 
LIMIT 10;
```

**상품 재고 확인:**
```sql
SELECT id, name, stock 
FROM products 
WHERE id = 1;
```

**캡처할 내용:**
- SQL 쿼리 결과
- Order status (PENDING → COMPLETED/FAILED)
- Payment status (PENDING → SUCCESS/FAILED)
- Product stock (차감 여부)

---

## 추가 팁

### 로그 레벨 조정

더 자세한 로그를 보려면 `application.yml`:
```yaml
logging:
  level:
    com.loopers.domain.payment: DEBUG
    com.loopers.infrastructure.payment: DEBUG
    io.github.resilience4j: DEBUG
```

### PG Simulator 포트 확인

기본 포트: `8082`
- 확인: `application.yml`의 `pg.base-url`

### 테스트 후 원복

테스트용으로 수정한 코드는 원래대로 복구:
- 스케줄러 주기: `60000` (1분)
- cutoffTime: `minusMinutes(10)` (10분)
- PG Simulator 지연: `(100..500L).random()`

