# Round 4 μ‘μ—… κ³„νμ„

## π“‹ κ³Όμ  κ°μ”
μ£Όλ¬Έ μ‹, μ¬κ³ /ν¬μΈνΈ/μΏ ν°μ μ›μμ„±μ„ νΈλμ­μ…μΌλ΅ λ³΄μ¥ν•κ³ , λ™μ‹μ„± μ΄μλ¥Ό μ μ–΄ν•©λ‹λ‹¤.

## π― ν•µμ‹¬ λ©ν‘

### Must-Have (ν•„μ)
- β… DB νΈλμ­μ…
- β… Lock (λ‚™κ΄€μ /λΉ„κ΄€μ )
- β… λ™μ‹μ„± ν…μ¤νΈ

### Nice-To-Have (μ„ νƒ)
- β… μΏ ν° κ°λ…
- β… λ―ΈλΉ„ν• κΈ°λ¥ μ™„μ„±μ„ ν†µν• API λ§λ¬΄λ¦¬

## π”¨ κµ¬ν„ μ‘μ—… λ©λ΅

### 1οΈβƒ£ Coupon λ„λ©”μΈ κµ¬ν„

#### 1.1 μΏ ν° μ—”ν‹°ν‹° μ„¤κ³„
- [ ] `Coupon` μ—”ν‹°ν‹° μƒμ„±
  - `id`: μΏ ν° ID
  - `couponType`: μΏ ν° νƒ€μ… (μ •μ•΅/μ •λ¥ )
  - `discountAmount`: ν• μΈ κΈμ•΅ (μ •μ•΅ μΏ ν°)
  - `discountRate`: ν• μΈμ¨ (μ •λ¥  μΏ ν°)
  - `name`: μΏ ν° μ΄λ¦„
  - `description`: μΏ ν° μ„¤λ…
  - μƒμ„±/μμ • μ‹κ°„

#### 1.2 μ‚¬μ©μ-μΏ ν° μ—°κ²° μ—”ν‹°ν‹° μ„¤κ³„
- [ ] `UserCoupon` μ—”ν‹°ν‹° μƒμ„±
  - `id`: ID
  - `userId`: μ‚¬μ©μ ID
  - `couponId`: μΏ ν° ID
  - `isUsed`: μ‚¬μ© μ—¬λ¶€
  - `usedAt`: μ‚¬μ© μ‹κ°„
  - λ°κΈ‰/μ‚¬μ© μ‹κ°„

#### 1.3 μΏ ν° λ„λ©”μΈ λ΅μ§
- [ ] μΏ ν° νƒ€μ…λ³„ ν• μΈ κ³„μ‚° λ΅μ§ κµ¬ν„
  - μ •μ•΅ μΏ ν°: κ³ μ • κΈμ•΅ ν• μΈ
  - μ •λ¥  μΏ ν°: νΌμ„ΌνΈ ν• μΈ
- [ ] μΏ ν° μ‚¬μ© κ°€λ¥ μ—¬λ¶€ κ²€μ¦
  - μ‚¬μ©μκ°€ λ³΄μ ν• μΏ ν°μΈμ§€ ν™•μΈ
  - μ΄λ―Έ μ‚¬μ©λ μΏ ν°μΈμ§€ ν™•μΈ
- [ ] μΏ ν° μ‚¬μ© μ²λ¦¬ (μƒνƒ λ³€κ²½)

#### 1.4 μΏ ν° Repository & Service
- [ ] `CouponRepository` μƒμ„±
- [ ] `UserCouponRepository` μƒμ„±
- [ ] `CouponService` κµ¬ν„
  - μΏ ν° μ΅°ν
  - μ‚¬μ©μ μΏ ν° μ΅°ν
  - μΏ ν° μ‚¬μ© μ²λ¦¬

### 2οΈβƒ£ μ£Όλ¬Έ λ„λ©”μΈ νΈλμ­μ… & λ™μ‹μ„± μ μ–΄

#### 2.1 μ£Όλ¬Έ μ²λ¦¬ ν”λ΅μ° κ°μ„ 
ν„μ¬ Order λ„λ©”μΈμ— λ‹¤μ λ΅μ§ μ¶”κ°€:

```kotlin
1. μ£Όλ¬Έ μ”μ²­
2. "μ£Όλ¬Έμ„ μ„ν• μ²λ¦¬" (μ›μμ„± λ³΄μ¥ ν•„μ”)
   - μΏ ν° μ‚¬μ© λ° μ°¨κ° // λ™μ‹μ„± μ΄μ μ„ν— κµ¬κ°„
   - μƒν’ μ¬κ³  ν™•μΈ λ° μ°¨κ° // λ™μ‹μ„± μ΄μ μ„ν— κµ¬κ°„
   - μ‚¬μ©μ ν¬μΈνΈ ν™•μΈ λ° μ°¨κ° // λ™μ‹μ„± μ΄μ μ„ν— κµ¬κ°„
3. μ£Όλ¬Έ μ—”ν‹°ν‹° μƒμ„± λ° μ €μ¥
```

#### 2.2 OrderFacade/OrderService νΈλμ­μ… μ²λ¦¬
- [ ] μ£Όλ¬Έ μ”μ²­ DTOμ— `couponId` ν•„λ“ μ¶”κ°€
- [ ] `OrderFacade` λλ” `OrderService`μ—μ„ `@Transactional` μ μ©
- [ ] μ£Όλ¬Έ μ²λ¦¬ λ©”μ„λ“ κµ¬ν„:
  1. μΏ ν° κ²€μ¦ λ° μ‚¬μ© μ²λ¦¬
  2. μƒν’ μ¬κ³  ν™•μΈ λ° μ°¨κ°
  3. μ‚¬μ©μ ν¬μΈνΈ ν™•μΈ λ° μ°¨κ°
  4. μ£Όλ¬Έ κΈμ•΅ κ³„μ‚° (μΏ ν° ν• μΈ μ μ©)
  5. μ£Όλ¬Έ μ—”ν‹°ν‹° μƒμ„± λ° μ €μ¥
- [ ] μμ™Έ λ°μƒ μ‹ λ΅¤λ°± μ²λ¦¬

#### 2.3 Lock μ „λµ μ μ©

**λ™μ‹μ„± μ΄μκ°€ λ°μƒν•  μ μλ” μ§€μ :**
1. **μΏ ν° μ‚¬μ©**: λ™μΌν• μΏ ν°μ„ μ—¬λ¬ μ£Όλ¬Έμ—μ„ λ™μ‹ μ‚¬μ© μ‹λ„
2. **μ¬κ³  μ°¨κ°**: λ™μΌν• μƒν’μ„ μ—¬λ¬ μ£Όλ¬Έμ—μ„ λ™μ‹ κµ¬λ§¤
3. **ν¬μΈνΈ μ°¨κ°**: λ™μΌν• μ‚¬μ©μκ°€ μ—¬λ¬ μ£Όλ¬Έμ„ λ™μ‹ μ”μ²­

**Lock μ μ© λ°©λ²•:**

**λ°©λ²• 1: λΉ„κ΄€μ  λ½ (Pessimistic Lock)**
- [ ] `UserCouponRepository`μ— λΉ„κ΄€μ  λ½ μ μ©
  - `@Lock(LockModeType.PESSIMISTIC_WRITE)`
- [ ] `ProductRepository`μ— λΉ„κ΄€μ  λ½ μ μ© (μ¬κ³  μ΅°ν μ‹)
- [ ] `PointRepository` λλ” `UserRepository`μ— λΉ„κ΄€μ  λ½ μ μ© (ν¬μΈνΈ μ΅°ν μ‹)

**λ°©λ²• 2: λ‚™κ΄€μ  λ½ (Optimistic Lock)**
- [ ] κ° μ—”ν‹°ν‹°μ— `@Version` ν•„λ“ μ¶”κ°€
- [ ] μ¶©λ λ°μƒ μ‹ μ¬μ‹λ„ λ΅μ§ κµ¬ν„

**κ¶μ¥: λΉ„κ΄€μ  λ½ μ‚¬μ©**
- μ£Όλ¬Έ λ„λ©”μΈ νΉμ„±μƒ μ¶©λ κ°€λ¥μ„±μ΄ λ†’μ
- μ¬μ‹λ„ λ΅μ§λ³΄λ‹¤ λ…ν™•ν• μμ„ λ³΄μ¥μ΄ μ¤‘μ”

### 3οΈβƒ£ λ™μ‹μ„± ν…μ¤νΈ κµ¬ν„

#### 3.1 μΆ‹μ•„μ” λ™μ‹μ„± ν…μ¤νΈ
- [ ] λ™μΌν• μƒν’μ— λ€ν•΄ μ—¬λ¬ μ¤λ λ“κ°€ λ™μ‹μ— μΆ‹μ•„μ”/μ·¨μ† μ”μ²­
- [ ] μµμΆ… μΆ‹μ•„μ” κ°μκ°€ μ •ν™•ν λ°μλλ”μ§€ κ²€μ¦
- [ ] `CountDownLatch` λλ” `ExecutorService` μ‚¬μ©

#### 3.2 μΏ ν° λ™μ‹μ„± ν…μ¤νΈ
- [ ] λ™μΌν• μΏ ν°μΌλ΅ μ—¬λ¬ μ¤λ λ“κ°€ λ™μ‹μ— μ£Όλ¬Έ μ”μ²­
- [ ] μΏ ν°μ΄ λ‹¨ ν• λ²λ§ μ‚¬μ©λλ”μ§€ κ²€μ¦
- [ ] λ‚λ¨Έμ§€ μ£Όλ¬Έμ€ μ‹¤ν¨ν•΄μ•Ό ν•¨

#### 3.3 ν¬μΈνΈ λ™μ‹μ„± ν…μ¤νΈ
- [ ] λ™μΌν• μ‚¬μ©μκ°€ μ—¬λ¬ μ£Όλ¬Έμ„ λ™μ‹μ— μ”μ²­
- [ ] ν¬μΈνΈκ°€ μ •μƒμ μΌλ΅ μ°¨κ°λλ”μ§€ κ²€μ¦
- [ ] ν¬μΈνΈ λ¶€μ΅± μ‹ μ£Όλ¬Έ μ‹¤ν¨ ν™•μΈ

#### 3.4 μ¬κ³  λ™μ‹μ„± ν…μ¤νΈ
- [ ] λ™μΌν• μƒν’μ— λ€ν•΄ μ—¬λ¬ μ£Όλ¬Έμ΄ λ™μ‹μ— μ”μ²­
- [ ] μ¬κ³ κ°€ μ •μƒμ μΌλ΅ μ°¨κ°λλ”μ§€ κ²€μ¦
- [ ] μ¬κ³  λ¶€μ΅± μ‹ μ£Όλ¬Έ μ‹¤ν¨ ν™•μΈ

### 4οΈβƒ£ κΈ°μ΅΄ API μ™„μ„±λ„ λ³΄μ™„

#### 4.1 λ―ΈλΉ„ν• API κµ¬ν„ ν™•μΈ
- [ ] Users API μ™„μ „ κµ¬ν„ ν™•μΈ
  - POST /api/v1/users (νμ›κ°€μ…)
  - GET /api/v1/users/me (λ‚΄ μ •λ³΄ μ΅°ν)
- [ ] Points API μ™„μ „ κµ¬ν„ ν™•μΈ
  - POST /api/v1/points/charge (ν¬μΈνΈ μ¶©μ „)
  - GET /api/v1/points (λ³΄μ  ν¬μΈνΈ μ΅°ν)
- [ ] Brands API μ™„μ „ κµ¬ν„ ν™•μΈ
  - GET /api/v1/brands/{brandId}
- [ ] Products API μ™„μ „ κµ¬ν„ ν™•μΈ
  - GET /api/v1/products (λ©λ΅ μ΅°ν + ν•„ν„°/μ •λ ¬)
  - GET /api/v1/products/{productId}
- [ ] Like API μ™„μ „ κµ¬ν„ ν™•μΈ
  - POST /api/v1/like/products/{productId}
  - DELETE /api/v1/like/products/{productId}
  - GET /api/v1/like/products
- [ ] Orders API μ™„μ „ κµ¬ν„ ν™•μΈ
  - POST /api/v1/orders
  - GET /api/v1/orders
  - GET /api/v1/orders/{orderId}

#### 4.2 μ‘λ‹µ ν•μ‹ ν†µμΌ
- [ ] λ¨λ“  API μ‘λ‹µ ν•μ‹ μΌκ΄€μ„± ν™•μΈ
- [ ] μ—λ¬ μ‘λ‹µ ν•μ‹ ν†µμΌ
- [ ] HTTP μƒνƒ μ½”λ“ μ μ μ„± ν™•μΈ

## π§ ν…μ¤νΈ μ²΄ν¬λ¦¬μ¤νΈ

### Coupon λ„λ©”μΈ
- [ ] μΏ ν° μ •μ•΅/μ •λ¥  ν• μΈ κ³„μ‚° λ΅μ§ λ‹¨μ„ ν…μ¤νΈ
- [ ] μ‚¬μ©μ μΏ ν° λ³΄μ  μ—¬λ¶€ κ²€μ¦ ν…μ¤νΈ
- [ ] μ΄λ―Έ μ‚¬μ©λ μΏ ν° μ‚¬μ© μ‹λ„ μ‹ μ‹¤ν¨ ν…μ¤νΈ

### μ£Όλ¬Έ νΈλμ­μ…
- [ ] μ£Όλ¬Έ μ„±κ³µ μ‹, λ¨λ“  μ²λ¦¬κ°€ μ •μƒ λ°μλλ”μ§€ ν†µν•© ν…μ¤νΈ
- [ ] μΏ ν° μ‚¬μ© λ¶κ°€ μ‹ μ£Όλ¬Έ μ‹¤ν¨ λ° λ΅¤λ°± ν…μ¤νΈ
- [ ] μ¬κ³  λ¶€μ΅± μ‹ μ£Όλ¬Έ μ‹¤ν¨ λ° λ΅¤λ°± ν…μ¤νΈ
- [ ] ν¬μΈνΈ λ¶€μ΅± μ‹ μ£Όλ¬Έ μ‹¤ν¨ λ° λ΅¤λ°± ν…μ¤νΈ
- [ ] μ¤‘κ°„ λ‹¨κ³„ μ‹¤ν¨ μ‹ λ¨λ“  μ²λ¦¬ λ΅¤λ°± ν…μ¤νΈ

### λ™μ‹μ„± ν…μ¤νΈ
- [ ] μΆ‹μ•„μ” λ™μ‹μ„± ν…μ¤νΈ ν†µκ³Ό
- [ ] μΏ ν° λ™μ‹ μ‚¬μ© ν…μ¤νΈ ν†µκ³Ό
- [ ] ν¬μΈνΈ λ™μ‹ μ°¨κ° ν…μ¤νΈ ν†µκ³Ό
- [ ] μ¬κ³  λ™μ‹ μ°¨κ° ν…μ¤νΈ ν†µκ³Ό

## π“ κµ¬ν„ μ‹ μ£Όμμ‚¬ν•­

### νΈλμ­μ… μ²λ¦¬
1. **Application Layerμ—μ„ νΈλμ­μ… κ΄€λ¦¬**
   - OrderFacade λλ” OrderServiceμ—μ„ `@Transactional` μ μ©
   - λ„λ©”μΈ κ³„μΈµμ€ μμ λΉ„μ¦λ‹μ¤ λ΅μ§λ§ λ‹΄λ‹Ή

2. **μ›μμ„± λ³΄μ¥**
   - μΏ ν°/μ¬κ³ /ν¬μΈνΈ μ²λ¦¬λ” ν•λ‚μ νΈλμ­μ… μ•μ—μ„ μ²λ¦¬
   - ν•λ‚λΌλ„ μ‹¤ν¨ν•λ©΄ μ „μ²΄ λ΅¤λ°±

3. **μμ™Έ μ²λ¦¬**
   - λΉ„μ¦λ‹μ¤ μμ™Έλ” λ…ν™•ν• λ©”μ‹μ§€μ™€ ν•¨κ» λ°μƒ
   - μ²΄ν¬ μμ™Έλ³΄λ‹¤λ” λ°νƒ€μ„ μμ™Έ μ‚¬μ© κ¶μ¥

### Lock μ „λµ
1. **λΉ„κ΄€μ  λ½ μ‚¬μ© μ‹**
   - λ°λ“λ½ λ°©μ§€λ¥Ό μ„ν•΄ λ½ νλ“ μμ„ μΌκ΄€μ„± μ μ§€
   - μΏ ν° β†’ μ¬κ³  β†’ ν¬μΈνΈ μμ„λ΅ λ½ νλ“ κ¶μ¥
   - νƒ€μ„μ•„μ›ƒ μ„¤μ • κ³ λ ¤

2. **λ‚™κ΄€μ  λ½ μ‚¬μ© μ‹**
   - `@Version` ν•„λ“ μ¶”κ°€
   - μ¶©λ λ°μƒ μ‹ μ¬μ‹λ„ λ΅μ§ κµ¬ν„
   - μµλ€ μ¬μ‹λ„ νμ μ ν•

### λ™μ‹μ„± ν…μ¤νΈ
1. **ν…μ¤νΈ ν™κ²½ μ„¤μ •**
   - μ‹¤μ  DB μ‚¬μ© (H2 λλ” ν…μ¤νΈμ© MySQL/PostgreSQL)
   - `@SpringBootTest` μ‚¬μ©
   - λ©€ν‹° μ¤λ λ“ ν™κ²½ κµ¬μ„±

2. **ν…μ¤νΈ μ‘μ„± ν¨ν„΄**
   ```kotlin
   @Test
   fun `λ™μ‹μ„± ν…μ¤νΈ μμ‹`() {
       val threadCount = 10
       val executorService = Executors.newFixedThreadPool(threadCount)
       val latch = CountDownLatch(threadCount)

       repeat(threadCount) {
           executorService.submit {
               try {
                   // λ™μ‹ μ‹¤ν–‰ν•  λ΅μ§
               } finally {
                   latch.countDown()
               }
           }
       }

       latch.await()

       // κ²€μ¦ λ΅μ§
   }
   ```

## π€ μ‘μ—… μμ„ κ¶μ¥

1. **1λ‹¨κ³„: Coupon λ„λ©”μΈ κµ¬ν„** (κΈ°λ³Έ κΈ°λ¥)
   - μ—”ν‹°ν‹°, Repository, Service κµ¬ν„
   - λ‹¨μ„ ν…μ¤νΈ μ‘μ„±

2. **2λ‹¨κ³„: μ£Όλ¬Έμ— μΏ ν° μ μ©** (νΈλμ­μ… μ—†μ΄)
   - μ£Όλ¬Έ DTOμ— couponId μ¶”κ°€
   - μΏ ν° ν• μΈ λ΅μ§ μ μ©
   - κΈ°λ³Έ ν†µν•© ν…μ¤νΈ

3. **3λ‹¨κ³„: νΈλμ­μ… μ μ©**
   - OrderFacadeμ— @Transactional μ μ©
   - λ΅¤λ°± ν…μ¤νΈ μ‘μ„±

4. **4λ‹¨κ³„: Lock μ μ©**
   - λΉ„κ΄€μ  λ½ λλ” λ‚™κ΄€μ  λ½ μ μ©
   - κΈ°λ³Έ λ™μ‘ ν™•μΈ

5. **5λ‹¨κ³„: λ™μ‹μ„± ν…μ¤νΈ**
   - λ¨λ“  λ™μ‹μ„± μ‹λ‚λ¦¬μ¤ ν…μ¤νΈ μ‘μ„± λ° ν†µκ³Ό

6. **6λ‹¨κ³„: λ―ΈλΉ„ν• API λ³΄μ™„**
   - λ„λ½λ API κµ¬ν„
   - μ „μ²΄ API ν…μ¤νΈ

## π’΅ μ°Έκ³  μλ£

### Lock κ΄€λ ¨
- JPA Lock Mode: PESSIMISTIC_WRITE, PESSIMISTIC_READ, OPTIMISTIC
- `@Lock` μ–΄λ…Έν…μ΄μ… μ‚¬μ©λ²•
- `@Version` ν•„λ“λ¥Ό ν†µν• λ‚™κ΄€μ  λ½

### νΈλμ­μ… κ΄€λ ¨
- Spring `@Transactional` μ†μ„±
  - `propagation`: μ „ν λ λ²¨
  - `isolation`: κ²©λ¦¬ λ λ²¨
  - `timeout`: νƒ€μ„μ•„μ›ƒ
  - `rollbackFor`: λ΅¤λ°± μμ™Έ μ§€μ •

### λ™μ‹μ„± ν…μ¤νΈ
- `CountDownLatch`: μ¤λ λ“ λ™κΈ°ν™”
- `ExecutorService`: μ¤λ λ“ ν’€ κ΄€λ¦¬
- `CyclicBarrier`: λ¨λ“  μ¤λ λ“κ°€ νΉμ • μ§€μ μ— λ„λ‹¬ν•  λ•κΉμ§€ λ€κΈ°

---

## β… μ™„λ£ κΈ°μ¤€

- [ ] λ¨λ“  APIκ°€ μ •μƒ λ™μ‘
- [ ] μΏ ν° λ„λ©”μΈ μ™„μ „ κµ¬ν„
- [ ] μ£Όλ¬Έ μ²λ¦¬ νΈλμ­μ… μ μ©
- [ ] Lockμ„ ν†µν• λ™μ‹μ„± μ μ–΄
- [ ] λ¨λ“  λ™μ‹μ„± ν…μ¤νΈ ν†µκ³Ό
- [ ] μ£Όλ¬Έ μ‹¤ν¨ μ‹ λ΅¤λ°± ν™•μΈ
- [ ] μ½”λ“ λ¦¬λ·° μ¤€λΉ„ μ™„λ£

---

**ν™”μ΄ν…! π”¥**
