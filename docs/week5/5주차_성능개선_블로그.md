# ìƒí’ˆ ëª©ë¡ ì¡°íšŒ API ì„±ëŠ¥ ê°œì„ ê¸° ğŸš€

> Aggregate ê°„ ID ì°¸ì¡° íŒ¨í„´ ì ìš©ê³¼ ì¸ë±ìŠ¤ ìµœì í™”ë¡œ **API ì‘ë‹µ ì†ë„ 8ë°° ê°œì„ ** (400ms â†’ 50ms)

---

## ë“¤ì–´ê°€ë©°

ì´ì»¤ë¨¸ìŠ¤ í”„ë¡œì íŠ¸ì—ì„œ ë¸Œëœë“œë³„ ì¸ê¸° ìƒí’ˆ ì¡°íšŒ APIì˜ ì„±ëŠ¥ ë¬¸ì œë¥¼ ë°œê²¬í•˜ê³ , ì´ë¥¼ í•´ê²°í•œ ê³¼ì •ì„ ê³µìœ í•©ë‹ˆë‹¤.

**í…ŒìŠ¤íŠ¸ í™˜ê²½**
- ìƒí’ˆ ë°ì´í„°: 10ë§Œ ê±´
- ë¸Œëœë“œ: 100ê°œ
- API: ë¸Œëœë“œë³„ ìƒí’ˆ ëª©ë¡ ì¡°íšŒ (ì¢‹ì•„ìš” ìˆœ ì •ë ¬)

---

## ë¬¸ì œ ë°œê²¬

### ì´ˆê¸° ì„±ëŠ¥ ì¸¡ì •

API ì‘ë‹µ ì‹œê°„ì´ ì•½ **400ms**ë¡œ ì¸¡ì •ë˜ì—ˆìŠµë‹ˆë‹¤.

<!-- ğŸ“¸ ìº¡ì²˜ 3: IntelliJ HTTP Client Duration í‘œì‹œ ìŠ¤í¬ë¦°ìƒ· -->
![API ì‘ë‹µ ì‹œê°„ AS-IS](https://raw.githubusercontent.com/wlghsp/loopers-hodgepodge/master/docs/week5/image/api-response-time-as-is.png)

Hibernate ë¡œê·¸ë¥¼ í™•ì¸í•œ ê²°ê³¼, ì˜ˆìƒì¹˜ ëª»í•œ **3ê°œì˜ ì¿¼ë¦¬**ê°€ ì‹¤í–‰ë˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤.

<!-- ğŸ“¸ ìº¡ì²˜ 2: Hibernate ë¡œê·¸ì— ì¶œë ¥ëœ 3ê°œ ì¿¼ë¦¬ ìŠ¤í¬ë¦°ìƒ· -->
![3ê°œ ì¿¼ë¦¬ ë°œìƒ](https://raw.githubusercontent.com/wlghsp/loopers-hodgepodge/master/docs/week5/image/three-queries-as-is.png)

```sql
-- ì¿¼ë¦¬ 1: ìƒí’ˆ ëª©ë¡ ì¡°íšŒ (LEFT JOIN brands í¬í•¨)
SELECT p1_0.id, p1_0.brand_id, ...
FROM products p1_0
LEFT JOIN brands b1_0 ON b1_0.id = p1_0.brand_id
WHERE b1_0.id = ?
ORDER BY p1_0.likes_count DESC
LIMIT ?

-- ì¿¼ë¦¬ 2: ğŸš¨ Brand ì¡°íšŒ ì¿¼ë¦¬ ì¶”ê°€ ë°œìƒ!
SELECT b1_0.id, b1_0.name, ...
FROM brands b1_0
WHERE b1_0.id = ?

-- ì¿¼ë¦¬ 3: COUNT ì¿¼ë¦¬ (í˜ì´ì§•ìš©)
SELECT COUNT(*)
FROM products p1_0
WHERE p1_0.brand_id = ?
```

### ì¿¼ë¦¬ ì„±ëŠ¥ ë¶„ì„

MySQLì˜ `EXPLAIN`ìœ¼ë¡œ ì¿¼ë¦¬ ì‹¤í–‰ ê³„íšì„ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.

<!-- ğŸ“¸ ìº¡ì²˜ 4: EXPLAIN ê²°ê³¼ í…Œì´ë¸” ì „ì²´ ìŠ¤í¬ë¦°ìƒ· (AS-IS) -->
![EXPLAIN ê²°ê³¼ AS-IS](https://raw.githubusercontent.com/wlghsp/loopers-hodgepodge/master/docs/week5/image/explain-result-as-is.png)

| í•­ëª© | ê°’ | ë¬¸ì œì  |
|------|----|----|
| **type** | ALL | ì „ì²´ í…Œì´ë¸” ìŠ¤ìº” |
| **key** | NULL | ì¸ë±ìŠ¤ ë¯¸ì‚¬ìš© |
| **rows** | ~10,000 | ë„ˆë¬´ ë§ì€ í–‰ ê²€ì‚¬ |
| **Extra** | Using filesort | ì •ë ¬ ì¶”ê°€ ì‘ì—… |

ì¿¼ë¦¬ ì‹¤í–‰ ì‹œê°„ì€ ì•½ **350ms**ì˜€ìŠµë‹ˆë‹¤.

<!-- ğŸ“¸ ìº¡ì²˜ 5: SHOW PROFILES ê²°ê³¼ ìŠ¤í¬ë¦°ìƒ· (AS-IS) -->
![ì¿¼ë¦¬ ì‹¤í–‰ ì‹œê°„ AS-IS](https://raw.githubusercontent.com/wlghsp/loopers-hodgepodge/master/docs/week5/image/query-execution-time-as-is.png)

---

## í•´ê²° ê³¼ì •

### 1ë‹¨ê³„: ê·¼ë³¸ ì›ì¸ ë¶„ì„

ì²˜ìŒì—ëŠ” DTO Projection, Native Query ë“± ì—¬ëŸ¬ ë°©ë²•ì„ ì‹œë„í–ˆì§€ë§Œ, ê·¼ë³¸ì ì¸ ë¬¸ì œëŠ” **ì—”í‹°í‹° ì„¤ê³„**ì— ìˆì—ˆìŠµë‹ˆë‹¤.

```kotlin
// âŒ AS-IS: ë‹¤ë¥¸ Aggregateë¥¼ ê°ì²´ë¡œ ì°¸ì¡°
@Entity
class Product(
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "brand_id")
    var brand: Brand  // ë¬¸ì œ: ê°ì²´ ì°¸ì¡°
)
```

<!-- ğŸ“¸ ìº¡ì²˜ 6: Product ì—”í‹°í‹° Brand ì°¸ì¡° ì½”ë“œ ìŠ¤í¬ë¦°ìƒ· (AS-IS) -->
![Product ì—”í‹°í‹° AS-IS](https://raw.githubusercontent.com/wlghsp/loopers-hodgepodge/master/docs/week5/image/product-entity-as-is.png)

Productì™€ BrandëŠ” **ì„œë¡œ ë‹¤ë¥¸ Aggregate**ì…ë‹ˆë‹¤. ê°ì²´ ì°¸ì¡°ëŠ” ë‹¤ìŒ ë¬¸ì œë¥¼ ìœ ë°œí•©ë‹ˆë‹¤:
- N+1 ì¿¼ë¦¬ ë°œìƒ
- íŠ¸ëœì­ì…˜ ê²½ê³„ ë¶ˆëª…í™•
- ì˜ë„í•˜ì§€ ì•Šì€ ì—°ì‡„ ìˆ˜ì •

### 2ë‹¨ê³„: ID ì°¸ì¡° íŒ¨í„´ ì ìš©

Aggregate ê°„ì—ëŠ” **IDë¡œë§Œ ì°¸ì¡°**í•˜ë„ë¡ ì„¤ê³„ë¥¼ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.

```kotlin
// âœ… TO-BE: IDë§Œ ì°¸ì¡°
@Entity
class Product(
    @Column(name = "brand_id", nullable = false)
    var brandId: Long  // í•´ê²°: ID ì°¸ì¡°
)
```

<!-- ğŸ“¸ ìº¡ì²˜ 7: Product ì—”í‹°í‹° ê°œì„  ì½”ë“œ ìŠ¤í¬ë¦°ìƒ· (TO-BE) -->
![Product ì—”í‹°í‹° TO-BE](https://raw.githubusercontent.com/wlghsp/loopers-hodgepodge/master/docs/week5/image/product-entity-to-be.png)

ë™ì¼í•œ íŒ¨í„´ì„ OrderItemì—ë„ ì ìš©í•˜ì—¬ **ìŠ¤ëƒ…ìƒ· íŒ¨í„´**ì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

<!-- ğŸ“¸ ìº¡ì²˜ 8: OrderItem ì—”í‹°í‹° ê°œì„  ì½”ë“œ ìŠ¤í¬ë¦°ìƒ· -->
![OrderItem ì—”í‹°í‹°](https://raw.githubusercontent.com/wlghsp/loopers-hodgepodge/master/docs/week5/image/order-item-entity-to-be.png)

```kotlin
class OrderItem(
    productId: Long,      // Product IDë§Œ ì°¸ì¡°
    productName: String,  // ì£¼ë¬¸ ì‹œì  ìƒí’ˆëª… ì €ì¥
    price: Money,         // ì£¼ë¬¸ ì‹œì  ê°€ê²© ì €ì¥
    quantity: Quantity,
)
```

**ê°œì„  íš¨ê³¼:**

<!-- ğŸ“¸ ìº¡ì²˜ 9: ê°œì„  í›„ 2ê°œ ì¿¼ë¦¬ë§Œ ë°œìƒí•˜ëŠ” Hibernate ë¡œê·¸ ìŠ¤í¬ë¦°ìƒ· -->
![2ê°œ ì¿¼ë¦¬ë¡œ ê°ì†Œ](https://raw.githubusercontent.com/wlghsp/loopers-hodgepodge/master/docs/week5/image/two-queries-to-be.png)

```sql
-- ì¿¼ë¦¬ 1: ìƒí’ˆ ëª©ë¡ ì¡°íšŒ (LEFT JOIN ì œê±°!)
select p1_0.id, p1_0.brand_id, ...
from products p1_0
where p1_0.brand_id = ?
  and p1_0.deleted_at is null
order by p1_0.likes_count desc
limit ?

-- ì¿¼ë¦¬ 2: COUNT ì¿¼ë¦¬
select count(p1_0.id)
from products p1_0
where p1_0.brand_id = ?
  and p1_0.deleted_at is null
```

âœ… **ì¿¼ë¦¬ 3ê°œ â†’ 2ê°œ**
âœ… **Brand ì¡°íšŒ ì¿¼ë¦¬ ì™„ì „ ì œê±°**
âœ… **N+1 ë¬¸ì œ ì›ì²œ ì°¨ë‹¨**

---

## ì¸ë±ìŠ¤ ìµœì í™”

### ì¸ë±ìŠ¤ ì„¤ê³„

ì¿¼ë¦¬ íŒ¨í„´ì„ ë¶„ì„í•˜ì—¬ ë³µí•© ì¸ë±ìŠ¤ë¥¼ ì„¤ê³„í–ˆìŠµë‹ˆë‹¤.

```sql
WHERE brand_id = ?          -- í•„í„°ë§
ORDER BY likes_count DESC   -- ì •ë ¬

â†’ ë³µí•© ì¸ë±ìŠ¤: (brand_id, likes_count DESC)
```

<!-- ğŸ“¸ ìº¡ì²˜ 12: Product Entity ì¸ë±ìŠ¤ ì„¤ì • ì½”ë“œ ìŠ¤í¬ë¦°ìƒ· -->
![ì¸ë±ìŠ¤ ì„¤ì • ì½”ë“œ](https://raw.githubusercontent.com/wlghsp/loopers-hodgepodge/master/docs/week5/image/product-entity-index-config.png)

```kotlin
@Entity
@Table(
    name = "products",
    indexes = [
        Index(name = "idx_products_brand_likes",
              columnList = "brand_id, likes_count DESC"),
        Index(name = "idx_products_deleted_likes",
              columnList = "deleted_at, likes_count DESC")
    ]
)
class Product(...)
```

<!-- ì¸ë±ìŠ¤ ê°œë… ì´ë¯¸ì§€ -->
![ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ìŠ¤](https://raw.githubusercontent.com/wlghsp/loopers-hodgepodge/master/docs/week5/image/database-index-concept.png)

### ì¸ë±ìŠ¤ ì ìš© ì „í›„ ë¹„êµ

**ì ìš© ì „:**

<!-- ğŸ“¸ ìº¡ì²˜ 11: EXPLAIN ê²°ê³¼ (ì¸ë±ìŠ¤ ì ìš© ì „) -->
![EXPLAIN ì¸ë±ìŠ¤ ì ìš© ì „](https://raw.githubusercontent.com/wlghsp/loopers-hodgepodge/master/docs/week5/image/explain-before-index.png)

**ì ìš© í›„:**

<!-- ğŸ“¸ ìº¡ì²˜ 15: EXPLAIN ê²°ê³¼ (ì¸ë±ìŠ¤ ì ìš© í›„) -->
![EXPLAIN ì¸ë±ìŠ¤ ì ìš© í›„](https://raw.githubusercontent.com/wlghsp/loopers-hodgepodge/master/docs/week5/image/explain-after-index.png)

| í•­ëª© | AS-IS | TO-BE | ê°œì„  |
|------|-------|-------|------|
| **type** | ALL | ref | âœ… ì¸ë±ìŠ¤ ì°¸ì¡° ìŠ¤ìº” |
| **key** | NULL | idx_products_deleted_likes | âœ… ì¸ë±ìŠ¤ ì‚¬ìš© |
| **rows** | ~10,000 | 100 | âœ… 99% ê°ì†Œ |
| **Extra** | Using filesort | Using index condition | âœ… filesort ì œê±° |

**ì¿¼ë¦¬ ì‹¤í–‰ ì‹œê°„:**

<!-- ğŸ“¸ ìº¡ì²˜ 16: SHOW PROFILES ê²°ê³¼ ìŠ¤í¬ë¦°ìƒ· (TO-BE) -->
![ì¿¼ë¦¬ ì‹¤í–‰ ì‹œê°„ TO-BE](https://raw.githubusercontent.com/wlghsp/loopers-hodgepodge/master/docs/week5/image/query-execution-time-to-be.png)

**350ms â†’ 15ms** (23ë°° í–¥ìƒ) ğŸ‰

**API ì‘ë‹µ ì‹œê°„:**

<!-- ğŸ“¸ ìº¡ì²˜ 17: IntelliJ HTTP Client Duration í‘œì‹œ ìŠ¤í¬ë¦°ìƒ· (TO-BE) -->
![API ì‘ë‹µ ì‹œê°„ TO-BE](https://raw.githubusercontent.com/wlghsp/loopers-hodgepodge/master/docs/week5/image/api-response-time-to-be.png)

**400ms â†’ 50ms** (8ë°° í–¥ìƒ) ğŸš€

---

## Redis ìºì‹œ ì ìš©

### ìºì‹œ ì „ëµ

ì¸ë±ìŠ¤ ìµœì í™”ë¡œ ì„±ëŠ¥ì´ ê°œì„ ë˜ì—ˆì§€ë§Œ, ì¸ê¸° ìƒí’ˆì€ ì´ˆë‹¹ ìˆ˜ë°± ë²ˆ ì¡°íšŒë  ìˆ˜ ìˆì–´ Redis ìºì‹œë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.

<!-- Redis ìºì‹œ ê°œë… ì´ë¯¸ì§€ -->
![Redis ìºì‹œ](https://raw.githubusercontent.com/wlghsp/loopers-hodgepodge/master/docs/week5/image/redis-cache-concept.png)

**Look-Aside íŒ¨í„´ ì ìš©:**

```kotlin
fun getProduct(productId: Long): ProductInfo {
    // 1. ìºì‹œ ì¡°íšŒ
    val cached = productCacheStore.getProduct(productId)
    if (cached != null) return cached

    // 2. DB ì¡°íšŒ
    val product = productService.getProduct(productId)
    val productInfo = ProductInfo.from(product)

    // 3. ìºì‹œ ì €ì¥
    productCacheStore.setProduct(productId, productInfo)
    return productInfo
}
```

### ìºì‹œ í‚¤ ì„¤ê³„

```
ìƒí’ˆ ìƒì„¸: product:{productId}
ìƒí’ˆ ëª©ë¡: products:brand:{brandId}:sort:{sort}:page:{page}

ì˜ˆì‹œ:
- product:123
- products:brand:1:sort:LIKES_DESC:page:0
```

**TTL ì„¤ì •:**
- ìƒí’ˆ ìƒì„¸: 10ë¶„
- ìƒí’ˆ ëª©ë¡: 5ë¶„

### ìºì‹œ ì ìš© íš¨ê³¼

**ìºì‹œ ë¯¸ìŠ¤ (ì²« ì¡°íšŒ):**

<!-- ğŸ“¸ ìº¡ì²˜ 20: ìºì‹œ ë¯¸ìŠ¤ ì‹œ ì‘ë‹µ ì‹œê°„ -->
![ìºì‹œ ë¯¸ìŠ¤ ì‘ë‹µ ì‹œê°„](https://raw.githubusercontent.com/wlghsp/loopers-hodgepodge/master/docs/week5/image/cache-miss-response-time.png)

**ìºì‹œ íˆíŠ¸ (ì¬ì¡°íšŒ):**

<!-- ğŸ“¸ ìº¡ì²˜ 21: ìºì‹œ íˆíŠ¸ ì‹œ ì‘ë‹µ ì‹œê°„ -->
![ìºì‹œ íˆíŠ¸ ì‘ë‹µ ì‹œê°„](https://raw.githubusercontent.com/wlghsp/loopers-hodgepodge/master/docs/week5/image/cache-hit-response-time.png)

**50ms â†’ 5ms** (10ë°° í–¥ìƒ)

**Redis ìºì‹œ í™•ì¸:**

<!-- ğŸ“¸ ìº¡ì²˜ 22: Redis ìºì‹œ í‚¤ ëª©ë¡ -->
![Redis ìºì‹œ í‚¤ ëª©ë¡](https://raw.githubusercontent.com/wlghsp/loopers-hodgepodge/master/docs/week5/image/redis-cache-keys.png)

<!-- ğŸ“¸ ìº¡ì²˜ 23: Redis TTL í™•ì¸ -->
![Redis TTL í™•ì¸](https://raw.githubusercontent.com/wlghsp/loopers-hodgepodge/master/docs/week5/image/redis-ttl-check.png)

---

## ìµœì¢… ê²°ê³¼

### ì„±ëŠ¥ ê°œì„  ìš”ì•½

| ë‹¨ê³„ | ê°œì„  ë‚´ìš© | ê²°ê³¼ |
|------|----------|------|
| **AS-IS** | ì´ˆê¸° ìƒíƒœ | API 400ms, ì¿¼ë¦¬ 3ê°œ |
| **1ë‹¨ê³„** | Aggregate ë¶„ë¦¬ | ì¿¼ë¦¬ 2ê°œ (33%â†“) |
| **2ë‹¨ê³„** | ì¸ë±ìŠ¤ ìµœì í™” | API 50ms (8ë°°â†‘) |
| **3ë‹¨ê³„** | Redis ìºì‹œ | API 5ms (80ë°°â†‘) |

### ì¸¡ì • ì§€í‘œ

| í•­ëª© | AS-IS | TO-BE | ê°œì„ ìœ¨ |
|------|-------|-------|--------|
| **API ì‘ë‹µ ì‹œê°„** | 400ms | 5-50ms | ìµœëŒ€ 80ë°° |
| **ì¿¼ë¦¬ ì‹¤í–‰ ì‹œê°„** | 350ms | 15ms | 23ë°° |
| **ì¿¼ë¦¬ ê°œìˆ˜** | 3ê°œ | 0-2ê°œ | ìºì‹œ íˆíŠ¸ ì‹œ 0ê°œ |
| **DB ë¶€í•˜** | 100% | 20% | 80% ê°ì†Œ |

---

## ë°°ìš´ ì 

### 1. ì„¤ê³„ê°€ ì„±ëŠ¥ì˜ ê·¼ë³¸

Aggregate ê°„ ê°ì²´ ì°¸ì¡°ë¥¼ ID ì°¸ì¡°ë¡œ ë³€ê²½í•˜ë‹ˆ N+1 ë¬¸ì œê°€ ì›ì²œ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ì˜ëª»ëœ ì„¤ê³„ëŠ” ì•„ë¬´ë¦¬ ìµœì í™”í•´ë„ í•œê³„ê°€ ìˆìŠµë‹ˆë‹¤.

### 2. ì¸¡ì •ì˜ ì¤‘ìš”ì„±

EXPLAIN, Profiling ë“±ìœ¼ë¡œ **ì¶”ì¸¡ì´ ì•„ë‹Œ ì¸¡ì •**ì„ í†µí•´ ë¬¸ì œë¥¼ ì •í™•íˆ íŒŒì•…í–ˆìŠµë‹ˆë‹¤.

### 3. ë‹¨ê³„ì  ì ‘ê·¼

```
1. ì„¤ê³„ ê°œì„  (Aggregate ë¶„ë¦¬)
2. ì¸ë±ìŠ¤ ìµœì í™”
3. ìºì‹œ ì ìš©
```

ê° ë‹¨ê³„ë³„ë¡œ ì„±ëŠ¥ì„ ì¸¡ì •í•˜ë©° ì ì§„ì ìœ¼ë¡œ ê°œì„ í–ˆìŠµë‹ˆë‹¤.

---

## ë§ˆì¹˜ë©°

ì´ë²ˆ ì„±ëŠ¥ ìµœì í™”ì—ì„œëŠ” ì˜¬ë°”ë¥¸ Aggregateê°„ ê²½ê³„ ì„¤ê³„ê°€ ì œëŒ€ë¡œ ë˜ì§€ ì•Šì•˜ë‹¤ëŠ” ì ì„ í™•ì¸í•˜ê³  Aggregateë¥¼ ë¶„ë¦¬ ê°œì„ í•˜ê³  ê·¸ ìœ„ì— ì¸ë±ìŠ¤ì™€ ìºì‹œë¥¼ ì´ìš©í•˜ì—¬ ì¶”ê°€ ìµœì í™”í•˜ì˜€ìŠµë‹ˆë‹¤.

---

_ì‘ì„±ì¼: 2025ë…„ 11ì›” 27ì¼_
_íƒœê·¸: #ì„±ëŠ¥ìµœì í™” #DDD #Aggregate #ì¸ë±ìŠ¤ #Redis #MySQL_
